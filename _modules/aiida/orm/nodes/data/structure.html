

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="">
    
    
      
        <title>aiida.orm.nodes.data.structure - aim2dat  documentation</title>
      
    
    
      
        
        
      
      

    
    
    
      
    
        <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx_immaterial_theme.c145f3631d897b861.min.css?v=b0f86f06" />
        <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=eafc0fe6" />
        <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
        <link rel="stylesheet" type="text/css" href="../../../../../_static/contentui.css" />
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../index.html" title="aim2dat  documentation" class="md-header__button md-logo" aria-label="aim2dat  documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            aim2dat  documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              aiida.orm.nodes.data.structure
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aim2dat/aim2dat" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aim2dat
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../installation.html" class="md-tabs__link">
      <span class="md-ellipsis">Installation</span>
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../user_guide.html" class="md-tabs__link">
      <span class="md-ellipsis">User Guide</span>
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../examples.html" class="md-tabs__link">
      <span class="md-ellipsis">Examples</span>
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../autoapi/aim2dat/index.html" class="md-tabs__link">
      <span class="md-ellipsis">Python API</span>
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../api-aiida_processes.html" class="md-tabs__link">
      <span class="md-ellipsis">Aii<wbr>DA Processes</span>
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../../../changelog.html" class="md-tabs__link">
      <span class="md-ellipsis">Changelog</span>
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../index.html" title="aim2dat  documentation" class="md-nav__button md-logo" aria-label="aim2dat  documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>
    </a>
    aim2dat  documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aim2dat/aim2dat" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aim2dat
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1">
          <span class="md-ellipsis">Installation</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">Installation</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_1" type="checkbox" id="__nav_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../installation.html"><span title="/installation.rst (reference label)" class="md-ellipsis">Overview and Package Dependencies</span></a>
          
            <label for="__nav_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Overview and Package Dependencies" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/installation.rst (reference label)" class="md-ellipsis">Overview and Package Dependencies</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../inst_windows.html" class="md-nav__link">
        <span title="/inst_windows.rst (reference label)" class="md-ellipsis">Windows operating systems</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../inst_linux.html" class="md-nav__link">
        <span title="/inst_linux.rst (reference label)" class="md-ellipsis">Linux operating systems</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2">
          <span class="md-ellipsis">User Guide</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">User Guide</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../user_guide.html" class="md-nav__link">
        <span title="/user_guide.rst (reference label)" class="md-ellipsis">Overview</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../stra-overview.html"><span title="/stra-overview.rst (reference label)" class="md-ellipsis">Structural Analysis</span></a>
          
            <label for="__nav_2_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Structural Analysis" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/stra-overview.rst (reference label)" class="md-ellipsis">Structural Analysis</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../stra-structure.html" class="md-nav__link">
        <span title="/stra-structure.ipynb (reference label)" class="md-ellipsis">Representation of molecules and crystals</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../stra-multiple_structures.html" class="md-nav__link">
        <span title="/stra-multiple_structures.ipynb (reference label)" class="md-ellipsis">Handling multiple structures at once</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../stra-structure_importer.html" class="md-nav__link">
        <span title="/stra-structure_importer.ipynb (reference label)" class="md-ellipsis">Interfaces to online databases and random crystal generation</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../stra-surfaces.html" class="md-nav__link">
        <span title="/stra-surfaces.ipynb (reference label)" class="md-ellipsis">Creating surfaces from bulk crystals</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../htw-overview.html"><span title="/htw-overview.rst (reference label)" class="md-ellipsis">High-<wbr>throughput Workflows</span></a>
          
            <label for="__nav_2_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="High-throughput Workflows" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          <span title="/htw-overview.rst (reference label)" class="md-ellipsis">High-<wbr>throughput Workflows</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../htw-workflow_builders.html" class="md-nav__link">
        <span title="/htw-workflow_builders.ipynb (reference label)" class="md-ellipsis">Handling complex workflows using the workflow builders</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../htw-cp2k_calculations.html" class="md-nav__link">
        <span title="/htw-cp2k_calculations.ipynb (reference label)" class="md-ellipsis">Running high-<wbr>throughput calculations using CP2K</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../plots-overview.html"><span title="/plots-overview.rst (reference label)" class="md-ellipsis">Plots</span></a>
          
            <label for="__nav_2_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Plots" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          <span title="/plots-overview.rst (reference label)" class="md-ellipsis">Plots</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../plots-simple_plot.html" class="md-nav__link">
        <span title="/plots-simple_plot.ipynb (reference label)" class="md-ellipsis">Plotting with the Simple<wbr>Plot class</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../plots-properties_and_functions.html" class="md-nav__link">
        <span title="/plots-properties_and_functions.ipynb (reference label)" class="md-ellipsis">Common features</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../plots-subplots.html" class="md-nav__link">
        <span title="/plots-subplots.ipynb (reference label)" class="md-ellipsis">Subplots and grids</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../fa-overview.html" class="md-nav__link">
        <span title="/fa-overview.ipynb (reference label)" class="md-ellipsis">Function Analysis</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../ml-overview.html"><span title="/ml-overview.ipynb (reference label)" class="md-ellipsis">Machine Learning</span></a>
          
            <label for="__nav_2_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Machine Learning" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          <span title="/ml-overview.ipynb (reference label)" class="md-ellipsis">Machine Learning</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ml-scikit_learn.html" class="md-nav__link">
        <span title="/ml-scikit_learn.rst (reference label)" class="md-ellipsis">Scikit-<wbr>learn integration</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3">
          <span class="md-ellipsis">Examples</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">Examples</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../examples.html"><span title="/examples.rst (reference label)" class="md-ellipsis">Example List</span></a>
          
            <label for="__nav_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Example List" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/examples.rst (reference label)" class="md-ellipsis">Example List</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/fct-discretization.html" class="md-nav__link">
        <span title="/examples/fct-discretization.ipynb (reference label)" class="md-ellipsis">Creating a discretized grid to analyse functions</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/fct-fingerprint_comparison.html" class="md-nav__link">
        <span title="/examples/fct-fingerprint_comparison.ipynb (reference label)" class="md-ellipsis">Comparing two functions on a discretized grid</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-band_structure_and_pdos_cp2k.html" class="md-nav__link">
        <span title="/examples/plots-band_structure_and_pdos_cp2k.ipynb (reference label)" class="md-ellipsis">Plotting the band structure and projected density of states <wbr>(p<wbr>DOS) from CP2K output-<wbr>files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-band_structure_and_pdos_fhi-aims.html" class="md-nav__link">
        <span title="/examples/plots-band_structure_and_pdos_fhi-aims.ipynb (reference label)" class="md-ellipsis">Plotting the band structure and projected density of states <wbr>(p<wbr>DOS) from FHI-<wbr>aims output files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-band_structure_and_pdos_phonopy.html" class="md-nav__link">
        <span title="/examples/plots-band_structure_and_pdos_phonopy.ipynb (reference label)" class="md-ellipsis">Plotting the band structure, projected density of states <wbr>(p<wbr>DOS) and thermal properties from phonopy output-<wbr>files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-band_structure_and_pdos_qe.html" class="md-nav__link">
        <span title="/examples/plots-band_structure_and_pdos_qe.ipynb (reference label)" class="md-ellipsis">Plotting the band structure and projected density of states <wbr>(p<wbr>DOS) from Quantum ESPRESSO output-<wbr>files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-band_structure_materials_project.html" class="md-nav__link">
        <span title="/examples/plots-band_structure_materials_project.ipynb (reference label)" class="md-ellipsis">Plotting the band structure and projected density of states <wbr>(p<wbr>DOS) from Materials Project</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-partial_charges_critic2.html" class="md-nav__link">
        <span title="/examples/plots-partial_charges_critic2.ipynb (reference label)" class="md-ellipsis">Plotting atomic partial charges from Critic2 output-<wbr>files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-planar_fields_critic2.html" class="md-nav__link">
        <span title="/examples/plots-planar_fields_critic2.ipynb (reference label)" class="md-ellipsis">Plotting planar fields from Critic2 output files</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-simple_plot.html" class="md-nav__link">
        <span title="/examples/plots-simple_plot.ipynb (reference label)" class="md-ellipsis">Using the Simple<wbr>Plot class as a flexible plotting framework</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/plots-spectroscopy.html" class="md-nav__link">
        <span title="/examples/plots-spectroscopy.ipynb (reference label)" class="md-ellipsis">How to use the plots package to plot a x-<wbr>ray absorption spectrum</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/strct-coordination_number_analysis.html" class="md-nav__link">
        <span title="/examples/strct-coordination_number_analysis.ipynb (reference label)" class="md-ellipsis">Calculating the coordination numbers for different atomic sites</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/strct-odb_interfaces.html" class="md-nav__link">
        <span title="/examples/strct-odb_interfaces.ipynb (reference label)" class="md-ellipsis">Querying the structure pool for the Cs-<wbr>Te binary system</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../examples/strct-partial_rdf.html" class="md-nav__link">
        <span title="/examples/strct-partial_rdf.ipynb (reference label)" class="md-ellipsis">Calculating the F-<wbr>Fingerprint to compare crystal structures</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4">
          <span class="md-ellipsis">Python API</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python API" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">Python API</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/index.html"><span title="/autoapi/aim2dat/index.rst (reference label)" class="md-ellipsis">aim2dat</span></a>
          
            <label for="__nav_4_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/index.rst (reference label)" class="md-ellipsis">aim2dat</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1" type="checkbox" id="__nav_4_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/index.html#subpackages"><span title="/autoapi/aim2dat/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span></a>
          
            <label for="__nav_4_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Subpackages" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_1" type="checkbox" id="__nav_4_1_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/aiida_data/index.html"><span title="/autoapi/aim2dat/aiida_data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>data</span></a>
          
            <label for="__nav_4_1_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.aiida_data" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/aiida_data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>data</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_1_1" type="checkbox" id="__nav_4_1_1_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/aiida_data/index.html#submodules"><span title="/autoapi/aim2dat/aiida_data/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/aiida_data/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/aiida_data/gaussian_cube_data/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/aiida_data/gaussian_cube_data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>data.<wbr>gaussian_<wbr>cube_<wbr>data</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/aiida_data/surface_data/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/aiida_data/surface_data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>data.<wbr>surface_<wbr>data</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_2" type="checkbox" id="__nav_4_1_1_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/aiida_workflows/index.html"><span title="/autoapi/aim2dat/aiida_workflows/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>workflows</span></a>
          
            <label for="__nav_4_1_1_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.aiida_workflows" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/aiida_workflows/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>workflows</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_2_1" type="checkbox" id="__nav_4_1_1_2_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/aiida_workflows/index.html#submodules"><span title="/autoapi/aim2dat/aiida_workflows/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_2_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/aiida_workflows/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/aiida_workflows/utils/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/aiida_workflows/utils/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>workflows.<wbr>utils</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/aiida_workflows/workflow_builder/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/aiida_workflows/workflow_builder/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>aiida_<wbr>workflows.<wbr>workflow_<wbr>builder</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_3" type="checkbox" id="__nav_4_1_1_3" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/fct/index.html"><span title="/autoapi/aim2dat/fct/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct</span></a>
          
            <label for="__nav_4_1_1_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.fct" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_3">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/fct/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_3_1" type="checkbox" id="__nav_4_1_1_3_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/fct/index.html#submodules"><span title="/autoapi/aim2dat/fct/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_3_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/fct/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/fct/discretization/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/fct/discretization/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct.<wbr>discretization</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/fct/fingerprint/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/fct/fingerprint/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct.<wbr>fingerprint</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/fct/function_comparison/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/fct/function_comparison/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct.<wbr>function_<wbr>comparison</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/fct/hull/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/fct/hull/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct.<wbr>hull</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/fct/smearing/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/fct/smearing/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>fct.<wbr>smearing</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_4" type="checkbox" id="__nav_4_1_1_4" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/io/index.html"><span title="/autoapi/aim2dat/io/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io</span></a>
          
            <label for="__nav_4_1_1_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.io" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_4">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/io/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_4_1" type="checkbox" id="__nav_4_1_1_4_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/io/index.html#subpackages"><span title="/autoapi/aim2dat/io/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span></a>
          
            <label for="__nav_4_1_1_4_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Subpackages" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_4_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/io/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_4_1_1" type="checkbox" id="__nav_4_1_1_4_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/io/cp2k/index.html"><span title="/autoapi/aim2dat/io/cp2k/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cp2k</span></a>
          
            <label for="__nav_4_1_1_4_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.io.cp2k" data-md-level="6">
        <label class="md-nav__title" for="__nav_4_1_1_4_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/io/cp2k/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cp2k</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_4_1_1_1" type="checkbox" id="__nav_4_1_1_4_1_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/io/cp2k/index.html#submodules"><span title="/autoapi/aim2dat/io/cp2k/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_4_1_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="7">
        <label class="md-nav__title" for="__nav_4_1_1_4_1_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/io/cp2k/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/cp2k/bands_dos/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/cp2k/bands_dos/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cp2k.<wbr>bands_<wbr>dos</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/cp2k/restart/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/cp2k/restart/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cp2k.<wbr>restart</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/cp2k/stdout/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/cp2k/stdout/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cp2k.<wbr>stdout</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_4_2" type="checkbox" id="__nav_4_1_1_4_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/io/index.html#submodules"><span title="/autoapi/aim2dat/io/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_4_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_4_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/io/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/cif/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/cif/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>cif</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/critic2/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/critic2/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>critic2</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/fhi_aims/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/fhi_aims/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>fhi_<wbr>aims</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/phonopy/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/phonopy/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>phonopy</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/qe/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/qe/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>qe</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/utils/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/utils/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>utils</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/xmgrace/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/xmgrace/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>xmgrace</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/yaml/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/yaml/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>yaml</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/io/zeo/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/io/zeo/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>io.<wbr>zeo</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_5" type="checkbox" id="__nav_4_1_1_5" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/ml/index.html"><span title="/autoapi/aim2dat/ml/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml</span></a>
          
            <label for="__nav_4_1_1_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.ml" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_5">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/ml/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_5_1" type="checkbox" id="__nav_4_1_1_5_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/ml/index.html#submodules"><span title="/autoapi/aim2dat/ml/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_5_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_5_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/ml/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/ml/cell_grid_search/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/ml/cell_grid_search/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml.<wbr>cell_<wbr>grid_<wbr>search</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/ml/kernels/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/ml/kernels/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml.<wbr>kernels</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/ml/metrics/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/ml/metrics/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml.<wbr>metrics</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/ml/transformers/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/ml/transformers/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml.<wbr>transformers</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/ml/utils/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/ml/utils/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>ml.<wbr>utils</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/plots/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/plots/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>plots</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7" type="checkbox" id="__nav_4_1_1_7" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/index.html"><span title="/autoapi/aim2dat/strct/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct</span></a>
          
            <label for="__nav_4_1_1_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.strct" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_7">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_1" type="checkbox" id="__nav_4_1_1_7_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/index.html#subpackages"><span title="/autoapi/aim2dat/strct/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span></a>
          
            <label for="__nav_4_1_1_7_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Subpackages" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_7_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_1_1" type="checkbox" id="__nav_4_1_1_7_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/ext_analysis/index.html"><span title="/autoapi/aim2dat/strct/ext_analysis/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>analysis</span></a>
          
            <label for="__nav_4_1_1_7_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.strct.ext_analysis" data-md-level="6">
        <label class="md-nav__title" for="__nav_4_1_1_7_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/ext_analysis/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>analysis</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_1_1_1" type="checkbox" id="__nav_4_1_1_7_1_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/ext_analysis/index.html#submodules"><span title="/autoapi/aim2dat/strct/ext_analysis/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_7_1_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="7">
        <label class="md-nav__title" for="__nav_4_1_1_7_1_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/ext_analysis/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/strct/ext_analysis/decorator/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/strct/ext_analysis/decorator/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>analysis.<wbr>decorator</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_1_2" type="checkbox" id="__nav_4_1_1_7_1_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/ext_manipulation/index.html"><span title="/autoapi/aim2dat/strct/ext_manipulation/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>manipulation</span></a>
          
            <label for="__nav_4_1_1_7_1_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.strct.ext_manipulation" data-md-level="6">
        <label class="md-nav__title" for="__nav_4_1_1_7_1_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/ext_manipulation/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>manipulation</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_1_2_1" type="checkbox" id="__nav_4_1_1_7_1_2_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/ext_manipulation/index.html#submodules"><span title="/autoapi/aim2dat/strct/ext_manipulation/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_7_1_2_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="7">
        <label class="md-nav__title" for="__nav_4_1_1_7_1_2_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/ext_manipulation/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/strct/ext_manipulation/add_structure/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/strct/ext_manipulation/add_structure/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>manipulation.<wbr>add_<wbr>structure</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/strct/ext_manipulation/decorator/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/strct/ext_manipulation/decorator/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>ext_<wbr>manipulation.<wbr>decorator</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_7_2" type="checkbox" id="__nav_4_1_1_7_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/strct/index.html#submodules"><span title="/autoapi/aim2dat/strct/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_7_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_7_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/strct/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/strct/strct_io/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/strct/strct_io/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>strct.<wbr>strct_<wbr>io</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_8" type="checkbox" id="__nav_4_1_1_8" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/utils/index.html"><span title="/autoapi/aim2dat/utils/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils</span></a>
          
            <label for="__nav_4_1_1_8">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.utils" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_1_1_8">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/utils/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_8_1" type="checkbox" id="__nav_4_1_1_8_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/utils/index.html#subpackages"><span title="/autoapi/aim2dat/utils/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span></a>
          
            <label for="__nav_4_1_1_8_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Subpackages" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_8_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/utils/index.rst#subpackages (reference label)" class="md-ellipsis">Subpackages</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_8_1_1" type="checkbox" id="__nav_4_1_1_8_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/utils/data/index.html"><span title="/autoapi/aim2dat/utils/data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>data</span></a>
          
            <label for="__nav_4_1_1_8_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="aim2dat.utils.data" data-md-level="6">
        <label class="md-nav__title" for="__nav_4_1_1_8_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/utils/data/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>data</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_8_1_1_1" type="checkbox" id="__nav_4_1_1_8_1_1_1" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/utils/data/index.html#submodules"><span title="/autoapi/aim2dat/utils/data/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_8_1_1_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="7">
        <label class="md-nav__title" for="__nav_4_1_1_8_1_1_1">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/utils/data/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/data/atomic_radii/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/data/atomic_radii/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>data.<wbr>atomic_<wbr>radii</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/data/electronegativity/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/data/electronegativity/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>data.<wbr>electronegativity</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1_8_2" type="checkbox" id="__nav_4_1_1_8_2" >
      
      
      
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../../autoapi/aim2dat/utils/index.html#submodules"><span title="/autoapi/aim2dat/utils/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span></a>
          
            <label for="__nav_4_1_1_8_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Submodules" data-md-level="5">
        <label class="md-nav__title" for="__nav_4_1_1_8_2">
          <span class="md-nav__icon md-icon"></span>
          <span title="/autoapi/aim2dat/utils/index.rst#submodules (reference label)" class="md-ellipsis">Submodules</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/chem_formula/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/chem_formula/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>chem_<wbr>formula</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/dict_tools/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/dict_tools/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>dict_<wbr>tools</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/element_properties/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/element_properties/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>element_<wbr>properties</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/maths/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/maths/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>maths</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/space_groups/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/space_groups/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>space_<wbr>groups</span>
      </a>
    </li>
  

            
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../autoapi/aim2dat/utils/units/index.html" class="md-nav__link">
        <span title="/autoapi/aim2dat/utils/units/index.rst (reference label)" class="md-ellipsis">aim2dat.<wbr>utils.<wbr>units</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5">
          <span class="md-ellipsis">Aii<wbr>DA Processes</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AiiDA Processes" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">Aii<wbr>DA Processes</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../api-aiida_processes.html" class="md-nav__link">
        <span title="/api-aiida_processes.rst (reference label)" class="md-ellipsis">Aii<wbr>DA Processes</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6">
          <span class="md-ellipsis">Changelog</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Changelog" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          <span class="md-ellipsis">Changelog</span>
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../changelog.html" class="md-nav__link">
        <span title="/changelog.rst (reference label)" class="md-ellipsis">Changelog</span>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary">
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                  


<h1>Source code for aiida.orm.nodes.data.structure</h1><div class="highlight"><pre>
<span></span><code><span class="c1">###########################################################################</span>
<span class="c1"># Copyright (c), The AiiDA team. All rights reserved.                     #</span>
<span class="c1"># This file is part of the AiiDA code.                                    #</span>
<span class="c1">#                                                                         #</span>
<span class="c1"># The code is hosted on GitHub at https://github.com/aiidateam/aiida-core #</span>
<span class="c1"># For further information on the license, see the LICENSE.txt file        #</span>
<span class="c1"># For further information please visit http://www.aiida.net               #</span>
<span class="c1">###########################################################################</span>
<span class="sd">&quot;&quot;&quot;This module defines the classes for structures and all related</span>
<span class="sd">functions to operate on them.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aiida.common.constants</span> <span class="kn">import</span> <span class="n">elements</span>
<span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">UnsupportedSpeciesError</span>

<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Data</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;StructureData&#39;</span><span class="p">,</span> <span class="s1">&#39;Kind&#39;</span><span class="p">,</span> <span class="s1">&#39;Site&#39;</span><span class="p">)</span>

<span class="c1"># Threshold used to check if the mass of two different Site objects is the same.</span>

<span class="n">_MASS_THRESHOLD</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
<span class="c1"># Threshold to check if the sum is one or not</span>
<span class="n">_SUM_THRESHOLD</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
<span class="c1"># Default cell</span>
<span class="n">_DEFAULT_CELL</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="n">_valid_symbols</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">_atomic_masses</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]:</span> <span class="n">el</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
<span class="n">_atomic_numbers</span> <span class="o">=</span> <span class="p">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]:</span> <span class="n">num</span> <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">_get_valid_cell</span><span class="p">(</span><span class="n">inputcell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the cell in a valid format from a generic input.</span>

<span class="sd">    :raise ValueError: whenever the format is not valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">the_cell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inputcell</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_cell</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">the_cell</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cell must be a list of three vectors, each defined as a list of three coordinates.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">the_cell</span>


<span class="k">def</span> <span class="nf">get_valid_pbc</span><span class="p">(</span><span class="n">inputpbc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of three booleans for the periodic boundary conditions,</span>
<span class="sd">    in a valid format from a generic input.</span>

<span class="sd">    :raise ValueError: if the format is not valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputpbc</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">the_pbc</span> <span class="o">=</span> <span class="p">(</span><span class="n">inputpbc</span><span class="p">,</span> <span class="n">inputpbc</span><span class="p">,</span> <span class="n">inputpbc</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inputpbc</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="c1"># To manage numpy lists of bools, whose elements are of type numpy.bool_</span>
        <span class="c1"># and for which isinstance(i,bool) return False...</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inputpbc</span><span class="p">,</span> <span class="s1">&#39;tolist&#39;</span><span class="p">):</span>
            <span class="n">the_value</span> <span class="o">=</span> <span class="n">inputpbc</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">the_value</span> <span class="o">=</span> <span class="n">inputpbc</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">the_value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">the_pbc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">the_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">the_pbc</span> <span class="o">=</span> <span class="p">(</span><span class="n">the_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pbc length must be either one or three.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pbc elements are not booleans.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pbc must be a boolean or a list of three booleans.&#39;</span><span class="p">,</span> <span class="n">inputpbc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">the_pbc</span>


<span class="k">def</span> <span class="nf">has_ase</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:return: True if the ase module can be imported, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ase</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">has_pymatgen</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:return: True if the pymatgen module can be imported, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pymatgen</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">get_pymatgen_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:return: string with pymatgen version, None if can not import.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_pymatgen</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pymatgen</span> <span class="kn">import</span> <span class="n">__version__</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># this was changed in version 2022.0.3</span>
        <span class="kn">from</span> <span class="nn">pymatgen.core</span> <span class="kn">import</span> <span class="n">__version__</span>
    <span class="k">return</span> <span class="n">__version__</span>


<span class="k">def</span> <span class="nf">has_spglib</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:return: True if the spglib module can be imported, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">spglib</span>  <span class="c1"># noqa: F401</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">calc_cell_volume</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the three-dimensional cell volume in Angstrom^3.</span>

<span class="sd">    :param cell: the cell vectors; the must be a 3x3 list of lists of floats</span>
<span class="sd">    :returns: the cell volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">_create_symbols_tuple</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a tuple with the symbols provided. If a string is provided,</span>
<span class="sd">    this is converted to a tuple with one single element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">symbols_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbols</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symbols_list</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">symbols_list</span>


<span class="k">def</span> <span class="nf">_create_weights_tuple</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a tuple with the weights provided. If a number is provided,</span>
<span class="sd">    this is converted to a tuple with one single element.</span>
<span class="sd">    If None is provided, this is converted to the tuple (1.,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numbers</span>

    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">weights_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weights_tuple</span>


<span class="k">def</span> <span class="nf">create_automatic_kind_name</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a string obtained with the symbols appended one</span>
<span class="sd">    after the other, without spaces, in alphabetical order;</span>
<span class="sd">    if the site has a vacancy, a X is appended at the end too.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sorted_symbol_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>
    <span class="n">sorted_symbol_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># In-place sort</span>
    <span class="n">name_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sorted_symbol_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_vacancies</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="n">name_string</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
    <span class="k">return</span> <span class="n">name_string</span>


<span class="k">def</span> <span class="nf">validate_weights_tuple</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates the weight of the atomic kinds.</span>

<span class="sd">    :raise: ValueError if the weights_tuple is not valid.</span>

<span class="sd">    :param weights_tuple: the tuple to validate. It must be a</span>
<span class="sd">            a tuple of floats (as created by :func:_create_weights_tuple).</span>
<span class="sd">    :param threshold: a float number used as a threshold to check that the sum</span>
<span class="sd">            of the weights is &lt;= 1.</span>

<span class="sd">    If the sum is less than one, it means that there are vacancies.</span>
<span class="sd">    Each element of the list must be &gt;= 0, and the sum must be &lt;= 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">weights_tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">w_sum</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The weight list is not valid (each element must be positive, and the sum must be &lt;= 1).&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_valid_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates the chemical symbol name.</span>

<span class="sd">    :return: True if the symbol is a valid chemical symbol (with correct</span>
<span class="sd">        capitalization), or the dummy X, False otherwise.</span>

<span class="sd">    Recognized symbols are for elements from hydrogen (Z=1) to lawrencium</span>
<span class="sd">    (Z=103). In addition, a dummy element unknown name (Z=0) is supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">_valid_symbols</span>


<span class="k">def</span> <span class="nf">validate_symbols_tuple</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to validate whether the chemical species are valid.</span>

<span class="sd">    :param symbols_tuple: a tuple (or list) with the chemical symbols name.</span>
<span class="sd">    :raises: UnsupportedSpeciesError if any symbol in the tuple is not a valid chemical</span>
<span class="sd">        symbol (with correct capitalization).</span>

<span class="sd">    Refer also to the documentation of :func:is_valid_symbol</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">is_valid_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols_tuple</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedSpeciesError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;At least one element of the symbol list </span><span class="si">{</span><span class="n">symbols_tuple</span><span class="si">}</span><span class="s1"> has not been recognized.&#39;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">is_ase_atoms</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the ase_atoms parameter is actually a ase.Atoms object.</span>

<span class="sd">    :param ase_atoms: an object, expected to be an ase.Atoms.</span>
<span class="sd">    :return: a boolean.</span>

<span class="sd">    Requires the ability to import ase, by doing &#39;import ase&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ase</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">,</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">group_symbols</span><span class="p">(</span><span class="n">_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group a list of symbols to a list containing the number of consecutive</span>
<span class="sd">    identical symbols, and the symbol itself.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    * ``[&#39;Ba&#39;,&#39;Ti&#39;,&#39;O&#39;,&#39;O&#39;,&#39;O&#39;,&#39;Ba&#39;]`` will return</span>
<span class="sd">      ``[[1,&#39;Ba&#39;],[1,&#39;Ti&#39;],[3,&#39;O&#39;],[1,&#39;Ba&#39;]]``</span>

<span class="sd">    * ``[ [ [1,&#39;Ba&#39;],[1,&#39;Ti&#39;] ],[ [1,&#39;Ba&#39;],[1,&#39;Ti&#39;] ] ]`` will return</span>
<span class="sd">      ``[[2, [ [1, &#39;Ba&#39;], [1, &#39;Ti&#39;] ] ]]``</span>

<span class="sd">    :param _list: a list of elements representing a chemical formula</span>
<span class="sd">    :return: a list of length-2 lists of the form [ multiplicity , element ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">the_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span>
    <span class="n">the_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">grouped_list</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">the_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()]]</span>
    <span class="k">while</span> <span class="n">the_list</span><span class="p">:</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="n">the_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elem</span> <span class="o">==</span> <span class="n">grouped_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># same symbol is repeated</span>
            <span class="n">grouped_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grouped_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">elem</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">grouped_list</span>


<span class="k">def</span> <span class="nf">get_formula_from_symbol_list</span><span class="p">(</span><span class="n">_list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string with the formula obtained from the list of symbols.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    * ``[[1,&#39;Ba&#39;],[1,&#39;Ti&#39;],[3,&#39;O&#39;]]`` will return ``&#39;BaTiO3&#39;``</span>
<span class="sd">    * ``[[2, [ [1, &#39;Ba&#39;], [1, &#39;Ti&#39;] ] ]]`` will return ``&#39;(BaTi)2&#39;``</span>

<span class="sd">    :param _list: a list of symbols and multiplicities as obtained from</span>
<span class="sd">        the function group_symbols</span>
<span class="sd">    :param separator: a string used to concatenate symbols. Default empty.</span>

<span class="sd">    :return: a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_str</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">multiplicity_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multiplicity_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">list_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="n">multiplicity_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">list_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">get_formula_from_symbol_list</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span><span class="si">}</span><span class="s1">)</span><span class="si">{</span><span class="n">multiplicity_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_formula_from_symbol_list</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span><span class="si">}{</span><span class="n">multiplicity_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_str</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_formula_group</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string with the chemical formula from a list of chemical symbols.</span>
<span class="sd">    The formula is written in a compact&quot; way, i.e. trying to group as much as</span>
<span class="sd">    possible parts of the formula.</span>

<span class="sd">    .. note:: it works for instance very well if structure was obtained</span>
<span class="sd">        from an ASE supercell.</span>

<span class="sd">    Example of result:</span>
<span class="sd">    ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,</span>
<span class="sd">    &#39;Ba&#39;, &#39;Ti&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]`` will return ``&#39;(BaTiO3)2BaTi2O3&#39;``.</span>

<span class="sd">    :param symbol_list: list of symbols</span>
<span class="sd">        (e.g. [&#39;Ba&#39;,&#39;Ti&#39;,&#39;O&#39;,&#39;O&#39;,&#39;O&#39;])</span>
<span class="sd">    :param separator: a string used to concatenate symbols. Default empty.</span>
<span class="sd">    :returns: a string with the chemical formula for the given structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">group_together</span><span class="p">(</span><span class="n">_list</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:param _list: a list</span>
<span class="sd">        :param group_size: size of the groups</span>
<span class="sd">        :param offset: beginning grouping after offset elements</span>
<span class="sd">        :return : a list of lists made of groups of size group_size</span>
<span class="sd">            obtained by grouping list elements together</span>
<span class="sd">            The first elements (up to _list[offset-1]) are not grouped</span>
<span class="sd">        example:</span>
<span class="sd">            ``group_together([&#39;O&#39;,&#39;Ba&#39;,&#39;Ti&#39;,&#39;Ba&#39;,&#39;Ti&#39;],2,1) =</span>
<span class="sd">                [&#39;O&#39;,[&#39;Ba&#39;,&#39;Ti&#39;],[&#39;Ba&#39;,&#39;Ti&#39;]]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span>
        <span class="n">the_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">grouped_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
            <span class="n">grouped_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">the_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()])</span>

        <span class="k">while</span> <span class="n">the_list</span><span class="p">:</span>
            <span class="n">sub_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">the_list</span><span class="p">:</span>
                    <span class="n">sub_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">the_list</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="n">grouped_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grouped_list</span>

    <span class="k">def</span> <span class="nf">cleanout_symbol_list</span><span class="p">(</span><span class="n">_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:param _list: a list of groups of symbols and multiplicities</span>
<span class="sd">        :return : a list where all groups with multiplicity 1 have</span>
<span class="sd">            been reduced to minimum</span>
<span class="sd">        example: ``[[1,[[1,&#39;Ba&#39;]]]]`` will return ``[[1,&#39;Ba&#39;]]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">the_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">the_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">the_list</span>

    <span class="k">def</span> <span class="nf">group_together_symbols</span><span class="p">(</span><span class="n">_list</span><span class="p">,</span> <span class="n">group_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Successive application of group_together, group_symbols and</span>
<span class="sd">        cleanout_symbol_list, in order to group a symbol list, scanning all</span>
<span class="sd">        possible offsets, for a given group size</span>
<span class="sd">        :param _list: the symbol list (see function group_symbols)</span>
<span class="sd">        :param group_size: the size of the groups</span>
<span class="sd">        :return the_symbol_list: the new grouped symbol list</span>
<span class="sd">        :return has_grouped: True if we grouped something</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span>
        <span class="n">has_grouped</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">has_grouped</span> <span class="ow">and</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">group_size</span><span class="p">:</span>
            <span class="n">grouped_list</span> <span class="o">=</span> <span class="n">group_together</span><span class="p">(</span><span class="n">the_symbol_list</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">new_symbol_list</span> <span class="o">=</span> <span class="n">group_symbols</span><span class="p">(</span><span class="n">grouped_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_symbol_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouped_list</span><span class="p">):</span>
                <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_symbol_list</span><span class="p">)</span>
                <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="n">cleanout_symbol_list</span><span class="p">(</span><span class="n">the_symbol_list</span><span class="p">)</span>
                <span class="n">has_grouped</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># print get_formula_from_symbol_list(the_symbol_list)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">the_symbol_list</span><span class="p">,</span> <span class="n">has_grouped</span>

    <span class="k">def</span> <span class="nf">group_all_together_symbols</span><span class="p">(</span><span class="n">_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Successive application of the function group_together_symbols, to group</span>
<span class="sd">        a symbol list, scanning all possible offsets and group sizes</span>
<span class="sd">        :param _list: the symbol list (see function group_symbols)</span>
<span class="sd">        :return: the new grouped symbol list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">group_size</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">has_finished</span> <span class="ow">and</span> <span class="n">group_size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># try to group as much as possible by groups of size group_size</span>
            <span class="n">the_symbol_list</span><span class="p">,</span> <span class="n">has_grouped</span> <span class="o">=</span> <span class="n">group_together_symbols</span><span class="p">(</span><span class="n">the_symbol_list</span><span class="p">,</span> <span class="n">group_size</span><span class="p">)</span>
            <span class="n">has_finished</span> <span class="o">=</span> <span class="n">has_grouped</span>
            <span class="n">group_size</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># stop as soon as we managed to group something</span>
            <span class="c1"># or when the group_size is too big to get anything</span>

        <span class="k">return</span> <span class="n">the_symbol_list</span>

    <span class="c1"># initial grouping of the chemical symbols</span>
    <span class="n">old_symbol_list</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">new_symbol_list</span> <span class="o">=</span> <span class="n">group_symbols</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">)</span>

    <span class="c1"># successively apply the grouping procedure until the symbol list does not</span>
    <span class="c1"># change anymore</span>
    <span class="k">while</span> <span class="n">new_symbol_list</span> <span class="o">!=</span> <span class="n">old_symbol_list</span><span class="p">:</span>
        <span class="n">old_symbol_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_symbol_list</span><span class="p">)</span>
        <span class="n">new_symbol_list</span> <span class="o">=</span> <span class="n">group_all_together_symbols</span><span class="p">(</span><span class="n">old_symbol_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_formula_from_symbol_list</span><span class="p">(</span><span class="n">new_symbol_list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_formula</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hill&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string with the chemical formula.</span>

<span class="sd">    :param symbol_list: a list of symbols, e.g. ``[&#39;H&#39;,&#39;H&#39;,&#39;O&#39;]``</span>
<span class="sd">    :param mode: a string to specify how to generate the formula, can</span>
<span class="sd">        assume one of the following values:</span>

<span class="sd">        * &#39;hill&#39; (default): count the number of atoms of each species,</span>
<span class="sd">          then use Hill notation, i.e. alphabetical order with C and H</span>
<span class="sd">          first if one or several C atom(s) is (are) present, e.g.</span>
<span class="sd">          ``[&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;]`` will return ``&#39;C2H6O&#39;``</span>
<span class="sd">          ``[&#39;S&#39;,&#39;O&#39;,&#39;O&#39;,&#39;H&#39;,&#39;O&#39;,&#39;H&#39;,&#39;O&#39;]``  will return ``&#39;H2O4S&#39;``</span>
<span class="sd">          From E. A. Hill, J. Am. Chem. Soc., 22 (8), pp 478-494 (1900)</span>

<span class="sd">        * &#39;hill_compact&#39;: same as hill but the number of atoms for each</span>
<span class="sd">          species is divided by the greatest common divisor of all of them, e.g.</span>
<span class="sd">          ``[&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;O&#39;,&#39;O&#39;]``</span>
<span class="sd">          will return ``&#39;CH3O2&#39;``</span>

<span class="sd">        * &#39;reduce&#39;: group repeated symbols e.g.</span>
<span class="sd">          ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,</span>
<span class="sd">          &#39;Ba&#39;, &#39;Ti&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]`` will return ``&#39;BaTiO3BaTiO3BaTi2O3&#39;``</span>

<span class="sd">        * &#39;group&#39;: will try to group as much as possible parts of the formula</span>
<span class="sd">          e.g.</span>
<span class="sd">          ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,</span>
<span class="sd">          &#39;Ba&#39;, &#39;Ti&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]`` will return ``&#39;(BaTiO3)2BaTi2O3&#39;``</span>

<span class="sd">        * &#39;count&#39;: same as hill (i.e. one just counts the number</span>
<span class="sd">          of atoms of each species) without the re-ordering (take the</span>
<span class="sd">          order of the atomic sites), e.g.</span>
<span class="sd">          ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]``</span>
<span class="sd">          will return ``&#39;Ba2Ti2O6&#39;``</span>

<span class="sd">        * &#39;count_compact&#39;: same as count but the number of atoms</span>
<span class="sd">          for each species is divided by the greatest common divisor of</span>
<span class="sd">          all of them, e.g.</span>
<span class="sd">          ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]``</span>
<span class="sd">          will return ``&#39;BaTiO3&#39;``</span>

<span class="sd">    :param separator: a string used to concatenate symbols. Default empty.</span>

<span class="sd">    :return: a string with the formula</span>

<span class="sd">    .. note:: in modes reduce, group, count and count_compact, the</span>
<span class="sd">        initial order in which the atoms were appended by the user is</span>
<span class="sd">        used to group and/or order the symbols in the formula</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_formula_group</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>

    <span class="c1"># for hill and count cases, simply count the occurences of each</span>
    <span class="c1"># chemical symbol (with some re-ordering in hill)</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hill&#39;</span><span class="p">,</span> <span class="s1">&#39;hill_compact&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">symbol_list</span><span class="p">:</span>
            <span class="n">ordered_symbol_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">elem</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ordered_symbol_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">))</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">symbol_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">elem</span><span class="p">),</span> <span class="n">elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ordered_symbol_set</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;count_compact&#39;</span><span class="p">]:</span>
        <span class="n">ordered_symbol_indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">symbol_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">)])</span>
        <span class="n">ordered_symbol_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbol_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ordered_symbol_indexes</span><span class="p">]</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">symbol_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">elem</span><span class="p">),</span> <span class="n">elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ordered_symbol_set</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;reduce&#39;</span><span class="p">:</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="n">group_symbols</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mode should be hill, hill_compact, group, reduce, count or count_compact&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hill_compact&#39;</span><span class="p">,</span> <span class="s1">&#39;count_compact&#39;</span><span class="p">]:</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>

        <span class="n">the_gcd</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">the_symbol_list</span><span class="p">])</span>
        <span class="n">the_symbol_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">the_gcd</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">the_symbol_list</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">get_formula_from_symbol_list</span><span class="p">(</span><span class="n">the_symbol_list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_symbols_string</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string that tries to match as good as possible the symbols</span>
<span class="sd">    and weights. If there is only one symbol (no alloy) with 100%</span>
<span class="sd">    occupancy, just returns the symbol name. Otherwise, groups the full</span>
<span class="sd">    string in curly brackets, and try to write also the composition</span>
<span class="sd">    (with 2 precision only).</span>
<span class="sd">    If (sum of weights&lt;1), we indicate it with the X symbol followed</span>
<span class="sd">    by 1-sum(weights) (still with 2 digits precision, so it can be 0.00)</span>

<span class="sd">    :param symbols: the symbols as obtained from &lt;kind&gt;._symbols</span>
<span class="sd">    :param weights: the weights as obtained from &lt;kind&gt;._weights</span>

<span class="sd">    .. note:: Note the difference with respect to the symbols and the</span>
<span class="sd">        symbol properties!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">pieces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}{</span><span class="n">weight</span><span class="si">:</span><span class="s1">4.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_vacancies</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="n">pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X</span><span class="si">{</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">:</span><span class="s1">4.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pieces</span><span class="p">))</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">has_vacancies</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the sum of the weights is less than one.</span>
<span class="sd">    It uses the internal variable _SUM_THRESHOLD as a threshold.</span>
<span class="sd">    :param weights: the weights</span>
<span class="sd">    :return: a boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">w_sum</span> <span class="o">&lt;</span> <span class="n">_SUM_THRESHOLD</span>


<span class="k">def</span> <span class="nf">symop_ortho_from_fract</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a matrix for conversion from orthogonal to fractional</span>
<span class="sd">    coordinates.</span>

<span class="sd">    Taken from</span>
<span class="sd">    svn://www.crystallography.net/cod-tools/trunk/lib/perl5/Fractional.pm,</span>
<span class="sd">    revision 850.</span>

<span class="sd">    :param cell: array of cell parameters (three lengths and three angles)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>

    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">cell</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">180</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cg</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">sg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">cg</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">cb</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sg</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">ca</span> <span class="o">-</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">)</span> <span class="o">/</span> <span class="n">sg</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sg</span> <span class="o">*</span> <span class="n">sg</span> <span class="o">-</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">-</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">)</span> <span class="o">/</span> <span class="n">sg</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">symop_fract_from_ortho</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a matrix for conversion from fractional to orthogonal</span>
<span class="sd">    coordinates.</span>

<span class="sd">    Taken from</span>
<span class="sd">    svn://www.crystallography.net/cod-tools/trunk/lib/perl5/Fractional.pm,</span>
<span class="sd">    revision 850.</span>

<span class="sd">    :param cell: array of cell parameters (three lengths and three angles)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>

    <span class="kn">import</span> <span class="nn">numpy</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">cell</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">180</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cg</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">sg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
    <span class="n">ctg</span> <span class="o">=</span> <span class="n">cg</span> <span class="o">/</span> <span class="n">sg</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sg</span> <span class="o">*</span> <span class="n">sg</span> <span class="o">-</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">-</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">)</span>  <span class="c1"># noqa: N806</span>

    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">ctg</span><span class="p">,</span> <span class="p">(</span><span class="n">ca</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">-</span> <span class="n">cb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">D</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">sg</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">ca</span> <span class="o">-</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">cg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">sg</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sg</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">D</span><span class="p">)],</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">ase_refine_cell</span><span class="p">(</span><span class="n">aseatoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect the symmetry of the structure, remove symmetric atoms and</span>
<span class="sd">    refine unit cell.</span>

<span class="sd">    :param aseatoms: an ase.atoms.Atoms instance</span>
<span class="sd">    :param symprec: symmetry precision, used by spglib</span>
<span class="sd">    :return newase: refined cell with reduced set of atoms</span>
<span class="sd">    :return symmetry: a dictionary describing the symmetry space group</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">ase.atoms</span> <span class="kn">import</span> <span class="n">Atoms</span>
    <span class="kn">from</span> <span class="nn">spglib</span> <span class="kn">import</span> <span class="n">get_symmetry_dataset</span><span class="p">,</span> <span class="n">refine_cell</span>

    <span class="n">spglib_tuple</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">aseatoms</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span>
        <span class="n">aseatoms</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span>
        <span class="n">aseatoms</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">cell</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">numbers</span> <span class="o">=</span> <span class="n">refine_cell</span><span class="p">(</span><span class="n">spglib_tuple</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">refined_atoms</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">cell</span><span class="p">,</span>
        <span class="n">positions</span><span class="p">,</span>
        <span class="n">numbers</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sym_dataset</span> <span class="o">=</span> <span class="n">get_symmetry_dataset</span><span class="p">(</span><span class="n">refined_atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">unique_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_positions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;equivalent_atoms&#39;</span><span class="p">]):</span>
        <span class="n">unique_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">unique_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">unique_atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">unique_numbers</span><span class="p">,</span> <span class="n">scaled_positions</span><span class="o">=</span><span class="n">unique_positions</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unique_atoms</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;hm&#39;</span><span class="p">:</span> <span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;international&#39;</span><span class="p">],</span>
        <span class="s1">&#39;hall&#39;</span><span class="p">:</span> <span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;hall&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span>
        <span class="s1">&#39;rotations&#39;</span><span class="p">:</span> <span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;rotations&#39;</span><span class="p">],</span>
        <span class="s1">&#39;translations&#39;</span><span class="p">:</span> <span class="n">sym_dataset</span><span class="p">[</span><span class="s1">&#39;translations&#39;</span><span class="p">],</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">atom_kinds_to_html</span><span class="p">(</span><span class="n">atom_kind</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct in html format</span>

<span class="sd">    an alloy with 0.5 Ge, 0.4 Si and 0.1 vacancy is represented as</span>
<span class="sd">    Ge&lt;sub&gt;0.5&lt;/sub&gt; + Si&lt;sub&gt;0.4&lt;/sub&gt; + vacancy&lt;sub&gt;0.1&lt;/sub&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">    -----</span>
<span class="sd">        atom_kind: a string with the name of the atomic kind, as printed by</span>
<span class="sd">        kind.get_symbols_string(), e.g. Ba0.80Ca0.10X0.10</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        html code for rendered formula</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse the formula (TODO can be made more robust though never fails if</span>
    <span class="c1"># it takes strings generated with kind.get_symbols_string())</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">matched_elements</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Z][a-z]*)([0-1][.[0-9]*]?)?&#39;</span><span class="p">,</span> <span class="n">atom_kind</span><span class="p">)</span>

    <span class="c1"># Compose the html string</span>
    <span class="n">html_formula_pieces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">matched_elements</span><span class="p">:</span>
        <span class="c1"># replace element X by &#39;vacancy&#39;</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;X&#39;</span> <span class="k">else</span> <span class="s1">&#39;vacancy&#39;</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">html_formula_pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s1">&lt;sub&gt;</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s1">&lt;/sub&gt;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html_formula_pieces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

    <span class="n">html_formula</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_formula_pieces</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">html_formula</span>


<div class="viewcode-block" id="StructureData">
<a class="viewcode-back" href="../../../../../autoapi/aim2dat/aiida_workflows/cp2k/pdos_work_chain/index.html#aim2dat.aiida_workflows.cp2k.calcjobs.StructureData">[docs]</a>
<span class="k">class</span> <span class="nc">StructureData</span><span class="p">(</span><span class="n">Data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class that represents an atomic structure.</span>

<span class="sd">    The data is organized as a collection of sites together with a cell, the boundary conditions (whether they are</span>
<span class="sd">    periodic or not) and other related useful information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_set_incompatibilities</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="s1">&#39;pbc&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pbc&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pbc&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pbc&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pymatgen&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pymatgen&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">_dimensionality_label</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">}</span>
    <span class="n">_internal_kind_tags</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pymatgen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pymatgen_structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pymatgen_molecule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cell&#39;</span><span class="p">:</span> <span class="n">cell</span><span class="p">,</span>
            <span class="s1">&#39;pbc&#39;</span><span class="p">:</span> <span class="n">pbc</span><span class="p">,</span>
            <span class="s1">&#39;ase&#39;</span><span class="p">:</span> <span class="n">ase</span><span class="p">,</span>
            <span class="s1">&#39;pymatgen&#39;</span><span class="p">:</span> <span class="n">pymatgen</span><span class="p">,</span>
            <span class="s1">&#39;pymatgen_structure&#39;</span><span class="p">:</span> <span class="n">pymatgen_structure</span><span class="p">,</span>
            <span class="s1">&#39;pymatgen_molecule&#39;</span><span class="p">:</span> <span class="n">pymatgen_molecule</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_incompatibilities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot pass </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s1"> at the same time&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ase</span><span class="p">,</span> <span class="n">pymatgen</span><span class="p">,</span> <span class="n">pymatgen_structure</span><span class="p">,</span> <span class="n">pymatgen_molecule</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">ase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_ase</span><span class="p">(</span><span class="n">ase</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pymatgen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_pymatgen</span><span class="p">(</span><span class="n">pymatgen</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pymatgen_structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_pymatgen_structure</span><span class="p">(</span><span class="n">pymatgen_structure</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pymatgen_molecule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_pymatgen_molecule</span><span class="p">(</span><span class="n">pymatgen_molecule</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">_DEFAULT_CELL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pbc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pbc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pbc</span><span class="p">(</span><span class="n">pbc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the dimensionality of the structure and its length/surface/volume.</span>

<span class="sd">        Zero-dimensional structures are assigned &quot;volume&quot; 0.</span>

<span class="sd">        :return: returns a dictionary with keys &quot;dim&quot; (dimensionality integer), &quot;label&quot; (dimensionality label)</span>
<span class="sd">            and &quot;value&quot; (numerical length/surface/volume).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_get_dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_ase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aseatoms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the structure from a ASE object&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_ase_atoms</span><span class="p">(</span><span class="n">aseatoms</span><span class="p">):</span>
            <span class="c1"># Read the ase structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">aseatoms</span><span class="o">.</span><span class="n">cell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="n">aseatoms</span><span class="o">.</span><span class="n">pbc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_kinds</span><span class="p">()</span>  <span class="c1"># This also calls clear_sites</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">aseatoms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_atom</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The value is not an ase.Atoms object&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the structure from a pymatgen object.</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typestr</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set_pymatgen_</span><span class="si">{</span><span class="n">typestr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converter for &#39;</span><span class="si">{</span><span class="n">typestr</span><span class="si">}</span><span class="s2">&#39; to AiiDA structure does not exist&quot;</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_pymatgen_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the structure from a pymatgen Molecule object.</span>

<span class="sd">        :param margin: the margin to be added in all directions of the</span>
<span class="sd">            bounding box of the molecule.</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">,</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pymatgen_structure</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">get_boxed_structure</span><span class="p">(</span><span class="o">*</span><span class="n">box</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_pymatgen_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the structure from a pymatgen Structure object.</span>

<span class="sd">        .. note:: periodic boundary conditions are set to True in all</span>
<span class="sd">            three directions.</span>
<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.3.5, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>

<span class="sd">        :raise ValueError: if there are partial occupancies together with spins.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">build_kind_name</span><span class="p">(</span><span class="n">species_and_occu</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Build a kind name from a pymatgen Composition, including an additional ordinal if spin is included,</span>
<span class="sd">            e.g. it returns &#39;&lt;specie&gt;1&#39; for an atom with spin &lt; 0 and &#39;&lt;specie&gt;2&#39; for an atom with spin &gt; 0,</span>
<span class="sd">            otherwise (no spin) it returns None</span>

<span class="sd">            :param species_and_occu: a pymatgen species and occupations dictionary</span>
<span class="sd">            :return: a string representing the kind name or None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">occupations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># As of v2023.9.2, the ``properties`` argument is removed and the ``spin`` argument should be used.</span>
            <span class="c1"># See: https://github.com/materialsproject/pymatgen/commit/118c245d6082fe0b13e19d348fc1db9c0d512019</span>
            <span class="c1"># The ``spin`` argument was introduced in v2023.6.28.</span>
            <span class="c1"># See: https://github.com/materialsproject/pymatgen/commit/9f2b3939af45d5129e0778d371d814811924aeb6</span>
            <span class="n">has_spin_attribute</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_spin&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_spin_attribute</span><span class="p">:</span>
                <span class="n">has_spin</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">spin</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="n">species</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_spin</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spin&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="n">species</span><span class="p">)</span>

            <span class="n">has_partial_occupancies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">occupations</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">occupations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span>

            <span class="k">if</span> <span class="n">has_partial_occupancies</span> <span class="ow">and</span> <span class="n">has_spin</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set partial occupancies and spins at the same time&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_spin</span><span class="p">:</span>
                <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">specie</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="n">species</span><span class="p">]</span>
                <span class="n">kind_name</span> <span class="o">=</span> <span class="n">create_automatic_kind_name</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">occupations</span><span class="p">)</span>

                <span class="c1"># If there is spin, we can only have a single specie, otherwise we would have raised above</span>
                <span class="n">specie</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">has_spin_attribute</span><span class="p">:</span>
                    <span class="n">spin</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">spin</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spin</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spin&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">spin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">kind_name</span> <span class="o">+=</span> <span class="s1">&#39;1&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kind_name</span> <span class="o">+=</span> <span class="s1">&#39;2&#39;</span>

                <span class="k">return</span> <span class="n">kind_name</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_kinds</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="n">species_and_occu</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">species</span>

            <span class="k">if</span> <span class="s1">&#39;kind_name&#39;</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="n">kind_name</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;kind_name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kind_name</span> <span class="o">=</span> <span class="n">build_kind_name</span><span class="p">(</span><span class="n">species_and_occu</span><span class="p">)</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">species_and_occu</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">site</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">kind_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kind_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">append_atom</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs some standard validation tests.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_get_valid_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid cell: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_valid_pbc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid periodic boundary conditions: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">_validate_dimensionality</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This will try to create the kinds objects</span>
            <span class="n">kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to validate the kinds: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kind with name &#39;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&#39; appears </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="si">}</span><span class="s2"> times instead of only one&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This will try to create the sites objects</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to validate the sites: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">kind_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A site has kind </span><span class="si">{</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="si">}</span><span class="s1">, but no specie with that name exists&#39;</span><span class="p">)</span>

        <span class="n">kinds_without_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">kind_name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kinds_without_sites</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The following kinds are defined, but there are no sites with that kind: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">kinds_without_sites</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_xsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the given structure to a string of format XSF (for XCrySDen).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alloy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_vacancies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;XSF for alloys or systems with vacancies not implemented.&#39;</span><span class="p">)</span>

        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>

        <span class="n">return_string</span> <span class="o">=</span> <span class="s1">&#39;CRYSTAL</span><span class="se">\n</span><span class="s1">PRIMVEC 1</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">cell_vector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">:</span>
            <span class="n">return_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">18.10f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cell_vector</span><span class="p">])</span>
            <span class="n">return_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">return_string</span> <span class="o">+=</span> <span class="s1">&#39;PRIMCOORD 1</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">return_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">))</span><span class="si">}</span><span class="s1"> 1</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="c1"># I checked above that it is not an alloy, therefore I take the</span>
            <span class="c1"># first symbol</span>
            <span class="n">return_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_atomic_numbers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="n">return_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%18.10f</span><span class="s1"> </span><span class="si">%18.10f</span><span class="s1"> </span><span class="si">%18.10f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_prepare_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the given structure to a string of format CIF.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">CifData</span>

        <span class="n">cif</span> <span class="o">=</span> <span class="n">CifData</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ase</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">cif</span><span class="o">.</span><span class="n">_prepare_cif</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_chemdoodle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the given structure to a string of format required by ChemDoodle.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">supercell_factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Get cell vectors and atomic position</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">))</span>
        <span class="n">base_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">)</span>

        <span class="n">start1</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">supercell_factors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">start2</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">supercell_factors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">start3</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">supercell_factors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">stop1</span> <span class="o">=</span> <span class="n">start1</span> <span class="o">+</span> <span class="n">supercell_factors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop2</span> <span class="o">=</span> <span class="n">start2</span> <span class="o">+</span> <span class="n">supercell_factors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stop3</span> <span class="o">=</span> <span class="n">start3</span> <span class="o">+</span> <span class="n">supercell_factors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">grid1</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="n">stop1</span><span class="p">)</span>
        <span class="n">grid2</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start2</span><span class="p">,</span> <span class="n">stop2</span><span class="p">)</span>
        <span class="n">grid3</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start3</span><span class="p">,</span> <span class="n">stop3</span><span class="p">)</span>

        <span class="n">atoms_json</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Manual recenter of the structure</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">grid1</span><span class="p">,</span> <span class="n">grid2</span><span class="p">,</span> <span class="n">grid3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">base_site</span> <span class="ow">in</span> <span class="n">base_sites</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">iy</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">iz</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="n">kind_name</span> <span class="o">=</span> <span class="n">base_site</span><span class="p">[</span><span class="s1">&#39;kind_name&#39;</span><span class="p">]</span>
                <span class="n">kind_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">kind_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_symbols_string</span><span class="p">()</span>

                <span class="n">atoms_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="n">kind_string</span><span class="p">,</span>
                        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">base_site</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">base_site</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">base_site</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;atomic_elements_html&#39;</span><span class="p">:</span> <span class="n">atom_kinds_to_html</span><span class="p">(</span><span class="n">kind_string</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="n">cell_json</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="s1">&#39;UnitCell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;s0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;xz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;yz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cell_json</span><span class="p">],</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">atoms_json</span><span class="p">}],</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;&amp;Aring;&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">return_dict</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_prepare_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_file_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the given structure to a string of format XYZ.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alloy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_vacancies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;XYZ for alloys or systems with vacancies not implemented.&#39;</span><span class="p">)</span>

        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>

        <span class="n">return_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s1">&#39;Lattice=&quot;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&quot; pbc=&quot;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="c1"># I checked above that it is not an alloy, therefore I take the</span>
            <span class="c1"># first symbol</span>
            <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{:6s}</span><span class="s1"> </span><span class="si">{:18.10f}</span><span class="s1"> </span><span class="si">{:18.10f}</span><span class="s1"> </span><span class="si">{:18.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">return_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">return_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_parse_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputstring</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the structure from a string of format XYZ.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.tools.data.structure</span> <span class="kn">import</span> <span class="n">xyz_parser_iterator</span>

        <span class="c1"># idiom to get to the last block</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">xyz_parser_iterator</span><span class="p">(</span><span class="n">inputstring</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The data does not contain any XYZ data&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_kinds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_atom</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="n">sym</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_adjust_default_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vacuum_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vacuum_addition</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the structure was imported from an xyz file, it lacks a cell.</span>
<span class="sd">        This method will adjust the cell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">def</span> <span class="nf">get_extremas_from_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns the minimum and maximum value for each dimension in the positions given&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">positions</span><span class="p">)]))</span>

        <span class="c1"># Calculating the minimal cell:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">site</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">])</span>
        <span class="n">position_min</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_extremas_from_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

        <span class="c1"># Translate the structure to the origin, such that the minimal values in each dimension</span>
        <span class="c1"># amount to (0,0,0)</span>
        <span class="n">positions</span> <span class="o">-=</span> <span class="n">position_min</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">)):</span>
            <span class="n">site</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="c1"># The orthorhombic cell that (just) accomodates the whole structure is now given by the</span>
        <span class="c1"># extremas of position in each dimension:</span>
        <span class="n">minimal_orthorhombic_cell_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_extremas_from_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">minimal_orthorhombic_cell_dimensions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vacuum_factor</span><span class="p">,</span> <span class="n">minimal_orthorhombic_cell_dimensions</span><span class="p">)</span>
        <span class="n">minimal_orthorhombic_cell_dimensions</span> <span class="o">+=</span> <span class="n">vacuum_addition</span>

        <span class="c1"># Transform the vector (a, b, c ) to [[a,0,0], [0,b,0], [0,0,c]]</span>
        <span class="n">newcell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">minimal_orthorhombic_cell_dimensions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">newcell</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Now set PBC (checks are done in set_pbc, no need to check anything here)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pbc</span><span class="p">(</span><span class="n">pbc</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a string with infos retrieved from StructureData node&#39;s properties</span>

<span class="sd">        :param self: the StructureData node</span>
<span class="sd">        :return: retsrt: the description string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formula</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hill_compact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_symbols_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a set containing the names of all elements involved in</span>
<span class="sd">        this structure (i.e., for it joins the list of symbols for each</span>
<span class="sd">        kind k in the structure).</span>

<span class="sd">        :returns: a set of strings of element names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span> <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;hill&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string with the chemical formula.</span>

<span class="sd">        :param mode: a string to specify how to generate the formula, can</span>
<span class="sd">            assume one of the following values:</span>

<span class="sd">            * &#39;hill&#39; (default): count the number of atoms of each species,</span>
<span class="sd">              then use Hill notation, i.e. alphabetical order with C and H</span>
<span class="sd">              first if one or several C atom(s) is (are) present, e.g.</span>
<span class="sd">              ``[&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;]`` will return ``&#39;C2H6O&#39;``</span>
<span class="sd">              ``[&#39;S&#39;,&#39;O&#39;,&#39;O&#39;,&#39;H&#39;,&#39;O&#39;,&#39;H&#39;,&#39;O&#39;]``  will return ``&#39;H2O4S&#39;``</span>
<span class="sd">              From E. A. Hill, J. Am. Chem. Soc., 22 (8), pp 478-494 (1900)</span>

<span class="sd">            * &#39;hill_compact&#39;: same as hill but the number of atoms for each</span>
<span class="sd">              species is divided by the greatest common divisor of all of them, e.g.</span>
<span class="sd">              ``[&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;C&#39;,&#39;H&#39;,&#39;H&#39;,&#39;H&#39;,&#39;O&#39;,&#39;O&#39;,&#39;O&#39;]``</span>
<span class="sd">              will return ``&#39;CH3O2&#39;``</span>

<span class="sd">            * &#39;reduce&#39;: group repeated symbols e.g.</span>
<span class="sd">              ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,</span>
<span class="sd">              &#39;Ba&#39;, &#39;Ti&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]`` will return ``&#39;BaTiO3BaTiO3BaTi2O3&#39;``</span>

<span class="sd">            * &#39;group&#39;: will try to group as much as possible parts of the formula</span>
<span class="sd">              e.g.</span>
<span class="sd">              ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;, &#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,</span>
<span class="sd">              &#39;Ba&#39;, &#39;Ti&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]`` will return ``&#39;(BaTiO3)2BaTi2O3&#39;``</span>

<span class="sd">            * &#39;count&#39;: same as hill (i.e. one just counts the number</span>
<span class="sd">              of atoms of each species) without the re-ordering (take the</span>
<span class="sd">              order of the atomic sites), e.g.</span>
<span class="sd">              ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]``</span>
<span class="sd">              will return ``&#39;Ba2Ti2O6&#39;``</span>

<span class="sd">            * &#39;count_compact&#39;: same as count but the number of atoms</span>
<span class="sd">              for each species is divided by the greatest common divisor of</span>
<span class="sd">              all of them, e.g.</span>
<span class="sd">              ``[&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;,&#39;Ba&#39;, &#39;Ti&#39;, &#39;O&#39;, &#39;O&#39;, &#39;O&#39;]``</span>
<span class="sd">              will return ``&#39;BaTiO3&#39;``</span>

<span class="sd">        :param separator: a string used to concatenate symbols. Default empty.</span>

<span class="sd">        :return: a string with the formula</span>

<span class="sd">        .. note:: in modes reduce, group, count and count_compact, the</span>
<span class="sd">            initial order in which the atoms were appended by the user is</span>
<span class="sd">            used to group and/or order the symbols in the formula</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbol_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_symbols_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">get_formula</span><span class="p">(</span><span class="n">symbol_list</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_site_kindnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list with length equal to the number of sites of this structure,</span>
<span class="sd">        where each element of the list is the kind name of the corresponding site.</span>

<span class="sd">        .. note:: This is NOT necessarily a list of chemical symbols! Use</span>
<span class="sd">            ``[ self.get_kind(s.kind_name).get_symbols_string() for s in self.sites]``</span>
<span class="sd">            for chemical symbols</span>

<span class="sd">        :return: a list of strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">this_site</span><span class="o">.</span><span class="n">kind_name</span> <span class="k">for</span> <span class="n">this_site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the chemical composition of this structure as a dictionary,</span>
<span class="sd">        where each key is the kind symbol (e.g. H, Li, Ba),</span>
<span class="sd">        and each value is the number of occurences of that element in this</span>
<span class="sd">        structure.</span>

<span class="sd">        :param mode: Specify the mode of the composition to return. Choose from ``full``, ``reduced`` or ``fractional``.</span>
<span class="sd">            For example, given the structure with formula Ba2Zr2O6, the various modes operate as follows.</span>
<span class="sd">            ``full``: The default, the counts are left unnnormalized.</span>
<span class="sd">            ``reduced``: The counts are renormalized to the greatest common denominator.</span>
<span class="sd">            ``fractional``: The counts are renormalized such that the sum equals 1.</span>

<span class="sd">        :returns: a dictionary with the composition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">symbols_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_symbols_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="n">symbols_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">symbols_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="n">symbols_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols_set</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;reduced&#39;</span><span class="p">:</span>
            <span class="n">gcd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gcd</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">symbols_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols_set</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="p">(</span><span class="n">symbols_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="o">/</span> <span class="n">gcd</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols_set</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fractional&#39;</span><span class="p">:</span>
            <span class="n">sum_comp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">symbols_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols_set</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="n">symbols_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_comp</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols_set</span><span class="p">}</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode `</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">` is invalid, choose from `full`, `reduced` or `fractional`.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the ASE object.</span>
<span class="sd">        Requires to be able to import ase.</span>

<span class="sd">        :return: an ASE object corresponding to this</span>
<span class="sd">          :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">          object.</span>

<span class="sd">        .. note:: If any site is an alloy or has vacancies, a ValueError</span>
<span class="sd">            is raised (from the site.get_ase() routine).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_ase</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get pymatgen object. Returns Structure for structures with</span>
<span class="sd">        periodic boundary conditions (in three dimensions) and Molecule</span>
<span class="sd">        otherwise.</span>
<span class="sd">        :param add_spin: True to add the spins to the pymatgen structure.</span>
<span class="sd">        Default is False (no spin added).</span>

<span class="sd">        .. note:: The spins are set according to the following rule:</span>

<span class="sd">            * if the kind name ends with 1 -&gt; spin=+1</span>

<span class="sd">            * if the kind name ends with 2 -&gt; spin=-1</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_pymatgen</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pymatgen_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the pymatgen Structure object.</span>
<span class="sd">        :param add_spin: True to add the spins to the pymatgen structure.</span>
<span class="sd">        Default is False (no spin added).</span>

<span class="sd">        .. note:: The spins are set according to the following rule:</span>

<span class="sd">            * if the kind name ends with 1 -&gt; spin=+1</span>

<span class="sd">            * if the kind name ends with 2 -&gt; spin=-1</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>

<span class="sd">        :return: a pymatgen Structure object corresponding to this</span>
<span class="sd">          :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">          object.</span>
<span class="sd">        :raise ValueError: if periodic boundary conditions do not hold</span>
<span class="sd">          in at least one dimension of real space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_pymatgen_structure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pymatgen_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the pymatgen Molecule object.</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>

<span class="sd">        :return: a pymatgen Molecule object corresponding to this</span>
<span class="sd">          :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">          object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_pymatgen_molecule</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">append_kind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a kind to the</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`.</span>
<span class="sd">        It makes a copy of the kind.</span>

<span class="sd">        :param kind: the site to append, must be a Kind object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>

        <span class="n">new_kind</span> <span class="o">=</span> <span class="n">Kind</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>  <span class="c1"># So we make a copy</span>

        <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A kind with the same name (</span><span class="si">{</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">) already exists.&#39;</span><span class="p">)</span>

        <span class="c1"># If here, no exceptions have been raised, so I add the site.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;kinds&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_kind</span><span class="o">.</span><span class="n">get_raw</span><span class="p">())</span>
        <span class="c1"># Note, this is a dict (with integer keys) so it allows for empty spots!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_kind_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_kind_tags</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_kind_tags</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kinds&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">_internal_tag</span>

    <span class="k">def</span> <span class="nf">append_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a site to the</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`.</span>
<span class="sd">        It makes a copy of the site.</span>

<span class="sd">        :param site: the site to append. It must be a Site object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>

        <span class="n">new_site</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>  <span class="c1"># So we make a copy</span>

        <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">kind_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No kind with name &#39;</span><span class="si">{</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="si">}</span><span class="s2">&#39;, available kinds are: </span><span class="si">{</span><span class="p">[</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If here, no exceptions have been raised, so I add the site.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_site</span><span class="o">.</span><span class="n">get_raw</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">append_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append an atom to the Structure, taking care of creating the</span>
<span class="sd">        corresponding kind.</span>

<span class="sd">        :param ase: the ase Atom object from which we want to create a new atom</span>
<span class="sd">                (if present, this must be the only parameter)</span>
<span class="sd">        :param position: the position of the atom (three numbers in angstrom)</span>
<span class="sd">        :param symbols: passed to the constructor of the Kind object.</span>
<span class="sd">        :param weights: passed to the constructor of the Kind object.</span>
<span class="sd">        :param name: passed to the constructor of the Kind object. See also the note below.</span>

<span class="sd">        .. note :: Note on the &#39;name&#39; parameter (that is, the name of the kind):</span>

<span class="sd">            * if specified, no checks are done on existing species. Simply,</span>
<span class="sd">              a new kind with that name is created. If there is a name</span>
<span class="sd">              clash, a check is done: if the kinds are identical, no error</span>
<span class="sd">              is issued; otherwise, an error is issued because you are trying</span>
<span class="sd">              to store two different kinds with the same name.</span>

<span class="sd">            * if not specified, the name is automatically generated. Before</span>
<span class="sd">              adding the kind, a check is done. If other species with the</span>
<span class="sd">              same properties already exist, no new kinds are created, but</span>
<span class="sd">              the site is added to the existing (identical) kind.</span>
<span class="sd">              (Actually, the first kind that is encountered).</span>
<span class="sd">              Otherwise, the name is made unique first, by adding to the string</span>
<span class="sd">              containing the list of chemical symbols a number starting from 1,</span>
<span class="sd">              until an unique name is found</span>

<span class="sd">        .. note :: checks of equality of species are done using</span>
<span class="sd">          the :py:meth:`~aiida.orm.nodes.data.structure.Kind.compare_with` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aseatom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aseatom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;If you pass &#39;ase&#39; as a parameter to &quot;</span> <span class="s1">&#39;append_atom, you cannot pass any further&#39;</span> <span class="s1">&#39;parameter&#39;</span>
                <span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">aseatom</span><span class="o">.</span><span class="n">position</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">Kind</span><span class="p">(</span><span class="n">ase</span><span class="o">=</span><span class="n">aseatom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You have to specify the position of the new atom&#39;</span><span class="p">)</span>
            <span class="c1"># all remaining parameters</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">Kind</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># I look for identical species only if the name is not specified</span>
        <span class="n">_kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span>

        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># If the kind is identical to an existing one, I use the existing</span>
            <span class="c1"># one, otherwise I replace it</span>
            <span class="n">exists_already</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">existing_kind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_kinds</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_kind</span><span class="o">.</span><span class="n">_internal_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_kind_tags</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># self._internal_kind_tags does not contain any info for</span>
                    <span class="c1"># the kind in position idx: I don&#39;t have to add anything</span>
                    <span class="c1"># then, and I continue</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">compare_with</span><span class="p">(</span><span class="n">existing_kind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">kind</span> <span class="o">=</span> <span class="n">existing_kind</span>
                    <span class="n">exists_already</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists_already</span><span class="p">:</span>
                <span class="c1"># There is not an identical kind.</span>
                <span class="c1"># By default, the name of &#39;kind&#39; just contains the elements.</span>
                <span class="c1"># I then check that the name of &#39;kind&#39; does not already exist,</span>
                <span class="c1"># and if it exists I add a number (starting from 1) until I</span>
                <span class="c1"># find a non-used name.</span>
                <span class="n">existing_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_kinds</span><span class="p">]</span>
                <span class="n">simplename</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">name</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">kind</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">existing_names</span><span class="p">:</span>
                    <span class="n">kind</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">simplename</span><span class="si">}{</span><span class="n">counter</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_kind</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;name&#39; was specified</span>
            <span class="n">old_kind</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">existing_kind</span> <span class="ow">in</span> <span class="n">_kinds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">existing_kind</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                    <span class="n">old_kind</span> <span class="o">=</span> <span class="n">existing_kind</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">old_kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_kind</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_the_same</span><span class="p">,</span> <span class="n">firstdiff</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">compare_with</span><span class="p">(</span><span class="n">old_kind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_the_same</span><span class="p">:</span>
                    <span class="n">kind</span> <span class="o">=</span> <span class="n">old_kind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;You are explicitly setting the name &#39;</span>
                        <span class="s2">&quot;of the kind to &#39;</span><span class="si">{}</span><span class="s2">&#39;, that already &quot;</span>
                        <span class="s1">&#39;exists, but the two kinds are different!&#39;</span>
                        <span class="s1">&#39; (first difference: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">firstdiff</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">site</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">kind_name</span><span class="o">=</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_site</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_kinds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all kinds for the StructureData object.</span>

<span class="sd">        .. note:: Also clear all sites!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;kinds&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_kind_tags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_sites</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes all sites for the StructureData object.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of sites.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">raw_sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Site</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">raw_sites</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kinds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of kinds.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kinds&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">raw_kinds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Kind</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">raw_kinds</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_kind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the kind object associated with the given kind name.</span>

<span class="sd">        :param kind_name: String, the name of the kind you want to get</span>

<span class="sd">        :return: The Kind object associated with the given kind_name, if</span>
<span class="sd">           a Kind with the given name is present in the structure.</span>

<span class="sd">        :raise: ValueError if the kind_name is not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cache the kinds, if stored, for efficiency</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kinds_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kinds_cache</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kinds_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">}</span>
                <span class="n">kinds_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kinds_cache</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kinds_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">}</span>

        <span class="c1"># Will raise ValueError if the kind is not present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kinds_dict</span><span class="p">[</span><span class="n">kind_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kind name &#39;</span><span class="si">{</span><span class="n">kind_name</span><span class="si">}</span><span class="s2">&#39; unknown&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_kind_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of kind names (in the same order of the ``self.kinds``</span>
<span class="sd">        property, but return the names rather than Kind objects)</span>

<span class="sd">        .. note:: This is NOT necessarily a list of chemical symbols! Use</span>
<span class="sd">            get_symbols_set for chemical symbols</span>

<span class="sd">        :return: a list of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the cell shape.</span>

<span class="sd">        :return: a 3x3 list of lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">))</span>

    <span class="nd">@cell</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the cell.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the cell.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>

        <span class="n">the_cell</span> <span class="o">=</span> <span class="n">_get_valid_cell</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="n">the_cell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the cell of a structure not yet stored to a new value.</span>

<span class="sd">        :param new_cell: list specifying the cell vectors</span>

<span class="sd">        :raises:</span>
<span class="sd">            ModificationNotAllowed: if object is already stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="n">new_cell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_sites_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_positions</span><span class="p">,</span> <span class="n">conserve_particle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace all the Site positions attached to the Structure</span>

<span class="sd">        :param new_positions: list of (3D) positions for every sites.</span>

<span class="sd">        :param conserve_particle: if True, allows the possibility of removing a site.</span>
<span class="sd">            currently not implemented.</span>

<span class="sd">        :raises aiida.common.ModificationNotAllowed: if object is stored already</span>
<span class="sd">        :raises ValueError: if positions are invalid</span>

<span class="sd">        .. note:: it is assumed that the order of the new_positions is</span>
<span class="sd">            given in the same order of the one it&#39;s substituting, i.e. the</span>
<span class="sd">            kind of the site will not be checked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">conserve_particle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># test consistency of th enew input</span>
            <span class="n">n_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_sites</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_positions</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conserve_particle</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the new positions should be as many as the previous structure.&#39;</span><span class="p">)</span>

            <span class="n">new_sites</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sites</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">this_pos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">new_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expecting a list of floats. Found instead </span><span class="si">{</span><span class="n">new_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expecting a list of lists of length 3. found instead </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">this_pos</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># now append this Site to the new_site list.</span>
                <span class="n">new_site</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># So we make a copy</span>
                <span class="n">new_site</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">this_pos</span><span class="p">)</span>
                <span class="n">new_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_site</span><span class="p">)</span>

            <span class="c1"># now clear the old sites, and substitute with the new ones</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_sites</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">this_new_site</span> <span class="ow">in</span> <span class="n">new_sites</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_site</span><span class="p">(</span><span class="n">this_new_site</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the periodic boundary conditions.</span>

<span class="sd">        :return: a tuple of three booleans, each one tells if there are periodic</span>
<span class="sd">            boundary conditions for the i-th real-space direction (i=1,2,3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return copy.deepcopy(self._pbc)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbc1&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbc2&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pbc3&#39;</span><span class="p">))</span>

    <span class="nd">@pbc</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the periodic boundary conditions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pbc</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the periodic boundary conditions.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.common.exceptions</span> <span class="kn">import</span> <span class="n">ModificationNotAllowed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stored</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModificationNotAllowed</span><span class="p">(</span><span class="s1">&#39;The StructureData object cannot be modified, it has already been stored&#39;</span><span class="p">)</span>
        <span class="n">the_pbc</span> <span class="o">=</span> <span class="n">get_valid_pbc</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># self._pbc = the_pbc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pbc1&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pbc2&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pbc3&#39;</span><span class="p">,</span> <span class="n">the_pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the lengths of cell lattice vectors in angstroms.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="nd">@cell_lengths</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cell_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell_lengths</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_cell_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Modification is not implemented yet&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the angles between the cell lattice vectors in degrees.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_lengths</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">]</span>

    <span class="nd">@cell_angles</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cell_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell_angles</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_cell_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Modification is not implemented yet&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_alloy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether the structure contains any alloy kinds.</span>

<span class="sd">        :return: a boolean, True if at least one kind is an alloy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">is_alloy</span> <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_vacancies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether the structure has vacancies in the structure.</span>

<span class="sd">        :return: a boolean, True if at least one kind has a vacancy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">has_vacancies</span> <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cell_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the three-dimensional cell volume in Angstrom^3.</span>

<span class="sd">        Use the `get_dimensionality` method in order to get the area/length of lower-dimensional cells.</span>

<span class="sd">        :return: a float.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">calc_cell_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="s1">&#39;ase&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates :py:class:`aiida.orm.nodes.data.cif.CifData`.</span>

<span class="sd">        .. versionadded:: 1.0</span>
<span class="sd">           Renamed from _get_cif</span>

<span class="sd">        :param converter: specify the converter. Default &#39;ase&#39;.</span>
<span class="sd">        :param store: If True, intermediate calculation gets stored in the</span>
<span class="sd">            AiiDA database for record. Default False.</span>
<span class="sd">        :return: :py:class:`aiida.orm.nodes.data.cif.CifData` node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">aiida.tools.data</span> <span class="kn">import</span> <span class="n">structure</span> <span class="k">as</span> <span class="n">structure_tools</span>

        <span class="kn">from</span> <span class="nn">.dict</span> <span class="kn">import</span> <span class="n">Dict</span>

        <span class="n">param</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conv_f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">structure_tools</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_get_cif_</span><span class="si">{</span><span class="n">converter</span><span class="si">}</span><span class="s1">_inline&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such converter &#39;</span><span class="si">{</span><span class="n">converter</span><span class="si">}</span><span class="s2">&#39; available&quot;</span><span class="p">)</span>
        <span class="n">ret_dict</span> <span class="o">=</span> <span class="n">conv_f</span><span class="p">(</span><span class="n">struct</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;store_provenance&#39;</span><span class="p">:</span> <span class="n">store</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">ret_dict</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_object_phonopyatoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts StructureData to PhonopyAtoms</span>

<span class="sd">        :return: a PhonopyAtoms object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">phonopy.structure.atoms</span> <span class="kn">import</span> <span class="n">PhonopyAtoms</span>

        <span class="n">atoms</span> <span class="o">=</span> <span class="n">PhonopyAtoms</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">kind_name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">])</span>
        <span class="c1"># Phonopy internally uses scaled positions, so you must store cell first!</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">set_positions</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">atoms</span>

    <span class="k">def</span> <span class="nf">_get_object_ase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">        to ase.Atoms</span>

<span class="sd">        :return: an ase.Atoms object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">ase</span>

        <span class="n">asecell</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pbc</span><span class="p">)</span>
        <span class="n">_kinds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinds</span>

        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="n">asecell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">get_ase</span><span class="p">(</span><span class="n">kinds</span><span class="o">=</span><span class="n">_kinds</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">asecell</span>

    <span class="k">def</span> <span class="nf">_get_object_pymatgen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">        to pymatgen object</span>

<span class="sd">        :return: a pymatgen Structure for structures with periodic boundary</span>
<span class="sd">            conditions (in three dimensions) and Molecule otherwise</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">==</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_pymatgen_structure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_pymatgen_molecule</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_object_pymatgen_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">        to pymatgen Structure object</span>
<span class="sd">        :param add_spin: True to add the spins to the pymatgen structure.</span>
<span class="sd">        Default is False (no spin added).</span>

<span class="sd">        .. note:: The spins are set according to the following rule:</span>

<span class="sd">            * if the kind name ends with 1 -&gt; spin=+1</span>

<span class="sd">            * if the kind name ends with 2 -&gt; spin=-1</span>

<span class="sd">        :return: a pymatgen Structure object corresponding to this</span>
<span class="sd">          :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">          object</span>
<span class="sd">        :raise ValueError: if periodic boundary conditions does not hold</span>
<span class="sd">          in at least one dimension of real space; if there are partial occupancies</span>
<span class="sd">          together with spins (defined by kind names ending with &#39;1&#39; or &#39;2&#39;).</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbc</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Periodic boundary conditions must apply in all three dimensions of real space&#39;</span><span class="p">)</span>

        <span class="n">species</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;add_spin&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind_names</span><span class="p">()):</span>
            <span class="c1"># case when spins are defined -&gt; no partial occupancy allowed</span>
            <span class="kn">from</span> <span class="nn">pymatgen.core.periodic_table</span> <span class="kn">import</span> <span class="n">Specie</span>

            <span class="n">oxidation_state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># now I always set the oxidation_state to zero</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set partial occupancies and spins at the same time&#39;</span><span class="p">)</span>
                <span class="n">spin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">specie</span> <span class="o">=</span> <span class="n">Specie</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oxidation_state</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;spin&#39;</span><span class="p">:</span> <span class="n">spin</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="c1"># As of v2023.9.2, the ``properties`` argument is removed and the ``spin`` argument should be used.</span>
                    <span class="c1"># See: https://github.com/materialsproject/pymatgen/commit/118c245d6082fe0b13e19d348fc1db9c0d512019</span>
                    <span class="c1"># The ``spin`` argument was introduced in v2023.6.28.</span>
                    <span class="c1"># See: https://github.com/materialsproject/pymatgen/commit/9f2b3939af45d5129e0778d371d814811924aeb6</span>
                    <span class="n">specie</span> <span class="o">=</span> <span class="n">Specie</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oxidation_state</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="n">spin</span><span class="p">)</span>
                <span class="n">species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">specie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case when no spin are defined</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span>
                <span class="n">species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="n">kind</span><span class="o">.</span><span class="n">weights</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">create_automatic_kind_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_site_kindnames</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="c1"># add &quot;kind_name&quot; as a properties to each site, whenever</span>
                <span class="c1"># the kind_name cannot be automatically obtained from the symbols</span>
                <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;site_properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kind_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_site_kindnames</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized parameters passed to pymatgen converter: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_object_pymatgen_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts</span>
<span class="sd">        :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">        to pymatgen Molecule object</span>

<span class="sd">        :return: a pymatgen Molecule object corresponding to this</span>
<span class="sd">          :py:class:`StructureData &lt;aiida.orm.nodes.data.structure.StructureData&gt;`</span>
<span class="sd">          object.</span>

<span class="sd">        .. note:: Requires the pymatgen module (version &gt;= 3.0.13, usage</span>
<span class="sd">            of earlier versions may cause errors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Molecule</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized parameters passed to pymatgen converter: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">species</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kind</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">kind_name</span><span class="p">)</span>
            <span class="n">species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="n">kind</span><span class="o">.</span><span class="n">weights</span><span class="p">)))</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">Kind</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class contains the information about the species (kinds) of the system.</span>

<span class="sd">    It can be a single atom, or an alloy, or even contain vacancies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a site.</span>
<span class="sd">        One can either pass:</span>

<span class="sd">        :param raw: the raw python dictionary that will be converted to a</span>
<span class="sd">               Kind object.</span>
<span class="sd">        :param ase: an ase Atom object</span>
<span class="sd">        :param kind: a Kind object (to get a copy)</span>

<span class="sd">        Or alternatively the following parameters:</span>

<span class="sd">        :param symbols: a single string for the symbol of this site, or a list</span>
<span class="sd">                   of symbol strings</span>
<span class="sd">        :param weights: (optional) the weights for each atomic species of</span>
<span class="sd">                   this site.</span>
<span class="sd">                   If only a single symbol is provided, then this value is</span>
<span class="sd">                   optional and the weight is set to 1.</span>
<span class="sd">        :param mass: (optional) the mass for this site in atomic mass units.</span>
<span class="sd">                   If not provided, the mass is set by the</span>
<span class="sd">                   self.reset_mass() function.</span>
<span class="sd">        :param name: a string that uniquely identifies the kind, and that</span>
<span class="sd">                   is used to identify the sites.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Internal variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># It will be remain to None in general; it is used to further</span>
        <span class="c1"># identify this species. At the moment, it is used only when importing</span>
        <span class="c1"># from ASE, if the species had a tag (different from zero).</span>
        <span class="c1">## NOTE! This is not persisted on DB but only used while the class</span>
        <span class="c1"># is loaded in memory (i.e., it is not output with the get_raw() method)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_tag</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Logic to create the site from the raw format</span>
        <span class="k">if</span> <span class="s1">&#39;raw&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass &#39;raw&#39;, then you cannot pass any other parameter.&quot;</span><span class="p">)</span>

            <span class="n">raw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_symbols_and_weights</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You didn&#39;t specify either &#39;symbols&#39; or &#39;weights&#39; in the raw site data.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You didn&#39;t specify the site mass in the raw site data.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You didn&#39;t specify the name in the raw site data.&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;kind&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass &#39;kind&#39;, then you cannot pass any other parameter.&quot;</span><span class="p">)</span>
            <span class="n">oldkind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_symbols_and_weights</span><span class="p">(</span><span class="n">oldkind</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="n">oldkind</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">oldkind</span><span class="o">.</span><span class="n">mass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">oldkind</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_tag</span> <span class="o">=</span> <span class="n">oldkind</span><span class="o">.</span><span class="n">_internal_tag</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Error using the Kind object. Are you sure &#39;</span>
                    <span class="s1">&#39;it is a Kind object? [Introspection says it is &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">oldkind</span><span class="p">)))</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;ase&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">aseatom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ase&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass &#39;ase&#39;, then you cannot pass any other parameter.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">numpy</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">set_symbols_and_weights</span><span class="p">([</span><span class="n">aseatom</span><span class="o">.</span><span class="n">symbol</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
                <span class="c1"># ASE sets mass to numpy.nan for unstable species</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">aseatom</span><span class="o">.</span><span class="n">mass</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">aseatom</span><span class="o">.</span><span class="n">mass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reset_mass</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Error using the aseatom object. Are you sure &#39;</span>
                    <span class="s1">&#39;it is a ase.atom.Atom object? [Introspection says it is &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">aseatom</span><span class="p">)))</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">aseatom</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_kind_name</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">aseatom</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_tag</span> <span class="o">=</span> <span class="n">aseatom</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_kind_name</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;symbols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;&#39;symbols&#39; need to be &quot;</span>
                    <span class="s1">&#39;specified (at least) to create a Site object. Otherwise, &#39;</span>
                    <span class="s2">&quot;pass a raw site using the &#39;raw&#39; parameter.&quot;</span>
                <span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_symbols_and_weights</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;symbols&#39;</span><span class="p">),</span> <span class="n">weights</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mass&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_mass</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_automatic_kind_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized parameters passed to Kind constructor: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the raw version of the site, mapped to a suitable dictionary.</span>
<span class="sd">        This is the format that is actually used to store each kind of the</span>
<span class="sd">        structure in the DB.</span>

<span class="sd">        :return: a python dictionary with the kind.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">reset_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the mass to the automatic calculated value.</span>

<span class="sd">        The mass can be set manually; by default, if not provided,</span>
<span class="sd">        it is the mass of the constituent atoms, weighted with their</span>
<span class="sd">        weight (after the weight has been normalized to one to take</span>
<span class="sd">        correctly into account vacancies).</span>

<span class="sd">        This function uses the internal _symbols and _weights values and</span>
<span class="sd">        thus assumes that the values are validated.</span>

<span class="sd">        It sets the mass to None if the sum of weights is zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w_sum</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_SUM_THRESHOLD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">w_sum</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>
        <span class="n">element_masses</span> <span class="o">=</span> <span class="p">(</span><span class="n">_atomic_masses</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">)</span>
        <span class="c1"># Weighted mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">normalized_weights</span><span class="p">,</span> <span class="n">element_masses</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the name of this kind.</span>
<span class="sd">        The name of a kind is used to identify the species of a site.</span>

<span class="sd">        :return: a string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the name of this site (a string).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_automatic_kind_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the type to a string obtained with the symbols appended one</span>
<span class="sd">        after the other, without spaces, in alphabetical order;</span>
<span class="sd">        if the site has a vacancy, a X is appended at the end too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_string</span> <span class="o">=</span> <span class="n">create_automatic_kind_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name_string</span><span class="si">}{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">compare_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_kind</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare with another Kind object to check if they are different.</span>

<span class="sd">        .. note:: This does NOT check the &#39;type&#39; attribute. Instead, it compares</span>
<span class="sd">            (with reasonable thresholds, where applicable): the mass, and the list</span>
<span class="sd">            of symbols and of weights. Moreover, it compares the</span>
<span class="sd">            ``_internal_tag``, if defined (at the moment, defined automatically</span>
<span class="sd">            only when importing the Kind from ASE, if the atom has a non-zero tag).</span>
<span class="sd">            Note that the _internal_tag is only used while the class is loaded,</span>
<span class="sd">            but is not persisted on the database.</span>

<span class="sd">        :return: A tuple with two elements. The first one is True if the two sites</span>
<span class="sd">            are &#39;equivalent&#39; (same mass, symbols and weights), False otherwise.</span>
<span class="sd">            The second element of the tuple is a string,</span>
<span class="sd">            which is either None (if the first element was True), or contains</span>
<span class="sd">            a &#39;human-readable&#39; description of the first difference encountered</span>
<span class="sd">            between the two sites.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check length of symbols</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Different length of symbols list&#39;</span><span class="p">)</span>

        <span class="c1"># Check list of symbols</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="o">!=</span> <span class="n">other_kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Symbol at position </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1"> are different (</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> vs. </span><span class="si">{</span><span class="n">other_kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="c1"># Check weights (assuming length of weights and of symbols have same</span>
        <span class="c1"># length, which should be always true</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="n">other_kind</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Weight at position </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1"> are different (</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s1"> vs. </span><span class="si">{</span><span class="n">other_kind</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="c1"># Check masses</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">-</span> <span class="n">other_kind</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MASS_THRESHOLD</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Masses are different (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="si">}</span><span class="s1"> vs. </span><span class="si">{</span><span class="n">other_kind</span><span class="o">.</span><span class="n">mass</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_tag</span> <span class="o">!=</span> <span class="n">other_kind</span><span class="o">.</span><span class="n">_internal_tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Internal tags are different (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_tag</span><span class="si">}</span><span class="s1"> vs. </span><span class="si">{</span><span class="n">other_kind</span><span class="o">.</span><span class="n">_internal_tag</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="c1"># If we got here, the two Site objects are similar enough</span>
        <span class="c1"># to be considered of the same kind</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The mass of this species kind.</span>

<span class="sd">        :return: a float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@mass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">the_mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">the_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The mass must be positive.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span> <span class="o">=</span> <span class="n">the_mass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weights for this species kind. Refer also to</span>
<span class="sd">        :func:validate_symbols_tuple for the validation rules on the weights.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>

    <span class="nd">@weights</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If value is a number, a single weight is used. Otherwise, a list or</span>
<span class="sd">        tuple of numbers is expected.</span>
<span class="sd">        None is also accepted, corresponding to the list [1.].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights_tuple</span> <span class="o">=</span> <span class="n">_create_weights_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot change the number of weights. Use the &#39;</span> <span class="s1">&#39;set_symbols_and_weights function instead.&#39;</span>
            <span class="p">)</span>
        <span class="n">validate_weights_tuple</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">,</span> <span class="n">_SUM_THRESHOLD</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights_tuple</span>

    <span class="k">def</span> <span class="nf">get_symbols_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string that tries to match as good as possible the symbols</span>
<span class="sd">        of this kind. If there is only one symbol (no alloy) with 100%</span>
<span class="sd">        occupancy, just returns the symbol name. Otherwise, groups the full</span>
<span class="sd">        string in curly brackets, and try to write also the composition</span>
<span class="sd">        (with 2 precision only).</span>

<span class="sd">        .. note:: If there is a vacancy (sum of weights&lt;1), we indicate it</span>
<span class="sd">            with the X symbol followed by 1-sum(weights) (still with 2</span>
<span class="sd">            digits precision, so it can be 0.00)</span>

<span class="sd">        .. note:: Note the difference with respect to the symbols and the</span>
<span class="sd">            symbol properties!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_symbols_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the kind has only one symbol, return it; otherwise, raise a</span>
<span class="sd">        ValueError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;This kind has more than one symbol (it is an alloy): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of symbols for this site. If the site is a single atom,</span>
<span class="sd">        pass a list of one element only, or simply the string for that atom.</span>
<span class="sd">        For alloys, a list of elements.</span>

<span class="sd">        .. note:: Note that if you change the list of symbols, the kind</span>
<span class="sd">            name remains unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">)</span>

    <span class="nd">@symbols</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If value is a string, a single symbol is used. Otherwise, a list or</span>
<span class="sd">        tuple of strings is expected.</span>

<span class="sd">        I set a copy of the list, so to avoid that the content changes</span>
<span class="sd">        after the value is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbols_tuple</span> <span class="o">=</span> <span class="n">_create_symbols_tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot change the number of symbols. Use the &#39;</span> <span class="s1">&#39;set_symbols_and_weights function instead.&#39;</span>
            <span class="p">)</span>
        <span class="n">validate_symbols_tuple</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span> <span class="o">=</span> <span class="n">symbols_tuple</span>

    <span class="k">def</span> <span class="nf">set_symbols_and_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the chemical symbols and the weights for the site.</span>

<span class="sd">        .. note:: Note that the kind name remains unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbols_tuple</span> <span class="o">=</span> <span class="n">_create_symbols_tuple</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        <span class="n">weights_tuple</span> <span class="o">=</span> <span class="n">_create_weights_tuple</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The number of symbols and weights must coincide.&#39;</span><span class="p">)</span>
        <span class="n">validate_symbols_tuple</span><span class="p">(</span><span class="n">symbols_tuple</span><span class="p">)</span>
        <span class="n">validate_weights_tuple</span><span class="p">(</span><span class="n">weights_tuple</span><span class="p">,</span> <span class="n">_SUM_THRESHOLD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span> <span class="o">=</span> <span class="n">symbols_tuple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="n">weights_tuple</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_alloy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether the Kind is an alloy, i.e. contains more than one element</span>

<span class="sd">        :return: boolean, True if the kind has more than one element, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_vacancies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether the Kind contains vacancies, i.e. when the sum of the weights is less than one.</span>

<span class="sd">        .. note:: the property uses the internal variable `_SUM_THRESHOLD` as a threshold.</span>

<span class="sd">        :return: boolean, True if the sum of the weights is less than one, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">has_vacancies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="si">!s}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbols_string</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;&quot;</span>


<span class="k">class</span> <span class="nc">Site</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class contains the information about a given site of the system.</span>

<span class="sd">    It can be a single atom, or an alloy, or even contain vacancies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a site.</span>

<span class="sd">        :param kind_name: a string that identifies the kind (species) of this site.</span>
<span class="sd">                This has to be found in the list of kinds of the StructureData</span>
<span class="sd">                object.</span>
<span class="sd">                Validation will be done at the StructureData level.</span>
<span class="sd">        :param position: the absolute position (three floats) in angstrom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass &#39;site&#39;, you cannot pass any further parameter to the Site constructor&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">Site</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;site&#39; must be of type Site&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">kind_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">position</span>
        <span class="k">elif</span> <span class="s1">&#39;raw&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass &#39;raw&#39;, you cannot pass any further parameter to the Site constructor&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;kind_name&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid raw object, it does not contain any key </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid raw object, it is not a dictionary&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;kind_name&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You need to specify </span><span class="si">{</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized parameters: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the raw version of the site, mapped to a suitable dictionary.</span>
<span class="sd">        This is the format that is actually used to store each site of the</span>
<span class="sd">        structure in the DB.</span>

<span class="sd">        :return: a python dictionary with the site.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;kind_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_ase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kinds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a ase.Atom object for this site.</span>

<span class="sd">        :param kinds: the list of kinds from the StructureData object.</span>

<span class="sd">        .. note:: If any site is an alloy or has vacancies, a ValueError</span>
<span class="sd">            is raised (from the site.get_ase() routine).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="kn">import</span> <span class="nn">ase</span>

        <span class="c1"># I create the list of tags</span>
        <span class="n">tag_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">used_tags</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
            <span class="c1"># Skip alloys and vacancies</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">is_alloy</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">has_vacancies</span><span class="p">:</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># If the kind name is equal to the specie name,</span>
            <span class="c1"># then no tag should be set</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Name is not the specie name</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_tag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
                        <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_tag</span><span class="p">)</span>
                        <span class="n">used_tags</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_tag</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># I use a string as a placeholder</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tag_list</span><span class="p">):</span>
            <span class="c1"># If it is a string, it is the name of the element,</span>
            <span class="c1"># and I have to generate a new integer for this element</span>
            <span class="c1"># and replace tag_list[i] with this new integer</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># I get a list of used tags for this element</span>
                <span class="n">existing_tags</span> <span class="o">=</span> <span class="n">used_tags</span><span class="p">[</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">existing_tags</span><span class="p">:</span>
                    <span class="n">new_tag</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">existing_tags</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># empty list</span>
                    <span class="n">new_tag</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># I store it also as a used tag!</span>
                <span class="n">used_tags</span><span class="p">[</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_tag</span><span class="p">)</span>
                <span class="c1"># I update the tag</span>
                <span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_tag</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">kind_candidate</span><span class="p">,</span> <span class="n">tag_candidate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kinds</span><span class="p">,</span> <span class="n">tag_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">kind_candidate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">kind_candidate</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">tag_candidate</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No kind &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span><span class="si">}</span><span class="s2">&#39; has been found in the list of kinds&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">is_alloy</span> <span class="ow">or</span> <span class="n">kind</span><span class="o">.</span><span class="n">has_vacancies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert to ASE if the kind represents an alloy or it has vacancies.&#39;</span><span class="p">)</span>
        <span class="n">aseatom</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mass</span><span class="o">=</span><span class="n">kind</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aseatom</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">return</span> <span class="n">aseatom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the kind name of this site (a string).</span>

<span class="sd">        The type of a site is used to decide whether two sites are identical</span>
<span class="sd">        (same mass, symbols, weights, ...) or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind_name</span>

    <span class="nd">@kind_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">kind_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the type of this site (a string).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kind_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the position of this site in absolute coordinates,</span>
<span class="sd">        in angstrom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">)</span>

    <span class="nd">@position</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the position of this site in absolute coordinates,</span>
<span class="sd">        in angstrom.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">internal_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1"># value is not iterable or elements are not floats or len != 3</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong format for position, must be a list of three float numbers.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">internal_pos</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="si">!s}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;kind name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_name</span><span class="si">}</span><span class="s2">&#39; @ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_get_dimensionality</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the dimensionality of the structure and its length/surface/volume.</span>

<span class="sd">    Zero-dimensional structures are assigned &quot;volume&quot; 0.</span>

<span class="sd">    :return: returns a dictionary with keys &quot;dim&quot; (dimensionality integer), &quot;label&quot; (dimensionality label)</span>
<span class="sd">        and &quot;value&quot; (numerical length/surface/volume).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">retdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">pbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pbc</span><span class="p">)</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbc</span><span class="p">[</span><span class="n">pbc</span><span class="p">])</span>

    <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
    <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StructureData</span><span class="o">.</span><span class="n">_dimensionality_label</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dimensionality </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1"> must be one of 0, 1, 2, 3&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># We have no concept of 0d volume. Let&#39;s return a value of 0 for a consistent output dictionary</span>
        <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">pbc</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="n">pbc</span><span class="p">]</span>
        <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">retdict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_cell_volume</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">retdict</span>


<span class="k">def</span> <span class="nf">_validate_dimensionality</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the given pbc and cell vectors are consistent.&quot;&quot;&quot;</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">_get_dimensionality</span><span class="p">(</span><span class="n">pbc</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>

    <span class="c1"># 0-d structures put no constraints on the cell</span>
    <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># finite-d structures should have a cell with finite volume</span>
    <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Structure has periodicity </span><span class="si">{</span><span class="n">pbc</span><span class="si">}</span><span class="s1"> but </span><span class="si">{</span><span class="n">dim</span><span class="p">[</span><span class="s2">&quot;dim&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">-d volume 0.&#39;</span><span class="p">)</span>

    <span class="k">return</span>
</code></pre></div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  
  
  <div class="md-footer-meta md-typeset">
    
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-footer-copyright__highlight">
        &#169; Copyright 2024, aim2dat developers.
        
    </div>
  
    Created using
    <a href="https://www.sphinx-doc.org/" target="_blank" rel="noopener">Sphinx</a>
    7.2.6.
     and
    <a href="https://github.com/jbms/sphinx-immaterial/" target="_blank" rel="noopener">Sphinx-Immaterial</a>
  
</div>
      
    </div>
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "toc.follow", "toc.sticky", "content.tabs.link", "announce.dismiss"], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
      
        <script src="../../../../../_static/sphinx_immaterial_theme.f9d9eeeb247ace16c.min.js?v=8ec58cb5"></script>
        <script src="../../../../../_static/design-tabs.js?v=36754332"></script>
        <script src="../../../../../_static/contentui.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    
  </body>
</html>